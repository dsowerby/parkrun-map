var mymap;var markerGroup;var $geo;var $specialEvents;$(document).ready(function(){initOptions();initMap();centreMap();initAndLoad()});navigator.geolocation.getCurrentPosition(function(a){position=a;initAndLoad()},function(b){initAndLoad()});function initOptions(){options=JSON.parse(Cookies.get("options")||"{}")}function initMap(){mymap=L.map("mapid",{fullscreenControl:true,fullscreenControlOptions:{position:"topright"},zoomControl:false,maxBounds:new L.LatLngBounds(new L.LatLng(-90,-180),new L.LatLng(90,180)),minZoom:2});L.control.zoom({position:"topright"}).addTo(mymap);markerGroup=L.featureGroup().addTo(mymap);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(mymap);mymap.on("contextmenu",function(c){window.location.hash="#closest-5-"+c.latlng.lat+","+c.latlng.lng})}function centreMap(){if(position){mymap.fitBounds([[position.coords.latitude-.01,position.coords.longitude-.01],[position.coords.latitude+.01,position.coords.longitude+.01]])}else{mymap.fitBounds([[49.095026,-7.742293],[60.258081000000004,1.847338]])}}function displayEvents(d){$.ajax({url:"https://www.parkrun.org.uk/special-events/",async:false}).done(function(e){$specialEvents=$(e);$specialEvents.find("td:nth-child(4):not(:contains(':'))").parent().remove();var f=$geo.find("e");for(var g=0;g<f.length;g++){var h=$(f[g]);var i=parseFloat(h.attr("lo"));var j=parseFloat(h.attr("la"));var k=h.attr("n");if(!isNaN(i)&&!isNaN(j)){if($specialEvents.find("td>a[href='http://www.parkrun.org.uk/"+k+"/'").length>0){addMarker(j,i,name,"green",h);displayedEvents++}}}if(displayedEvents>0){mymap.fitBounds(markerGroup.getBounds())}})}function addMarker(l,m,n,o,p){var q=L.icon({iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-"+o+".png",shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});var r=L.marker([l,m],{icon:q});var s;if(typeof p!=="undefined"){var t=p.attr("n");var u=p.attr("r");if(u!=""){var v=$geo.find("r[id="+u+"]").closest("r[u!='']").attr("u")}s='<strong><a target="_blank" href="'+v+"/"+t+'/">'+n+'</a></strong><br /><a target="_blank" href="'+v+"/"+t+'/course/">Course page</a><br /><a target="_blank" href="'+v+"/"+t+'/futureroster/">Future Roster</a><br /><a target="_blank" href="https://www.google.com/maps/dir/?api=1&destination='+l+","+m+'">Directions</a>'}else if(typeof n!=="undefined"){s=n}if(options.vegan){if(typeof s!=="undefined"){s+="<br />"}s+='<a target="_blank" href="https://www.happycow.net/searchmap?lat='+l+"&lng="+m+'&vegan=true">Local vegan food</a>'}r.bindPopup(s);r.addTo(markerGroup)}function filterEvents(w,x){return function(y){var z=[];for(var A=0;A<y.length;A++){var B=$(y[A]);if(x(B)){z.push(B)}}return z}}function load(){$(document).ready(function(){markerGroup.clearLayers();var C=decodeURIComponent(window.location.hash);filters=[];C.split("#").filter(function(D){return D}).forEach(function(E){var F=getFilter(E);if(F!==undefined){filters.push(F)}});displayEvents(filters)})}function init(){$.ajax({url:"./geo.xml",async:false}).done(function(G){$geo=$(G)})}function initAndLoad(){init();load()}
