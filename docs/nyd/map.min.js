var mymap;var markerGroup;var $geo;var $specialEvents;$(document).ready(function(){initOptions();initMap();centreMap();initAndLoad()});function initOptions(){options=JSON.parse(Cookies.get("options")||"{}")}function initMap(){mymap=L.map("mapid",{fullscreenControl:true,fullscreenControlOptions:{position:"topright"},zoomControl:false,maxBounds:new L.LatLngBounds(new L.LatLng(-90,-180),new L.LatLng(90,180)),minZoom:2});L.control.zoom({position:"topright"}).addTo(mymap);markerGroup=L.featureGroup().addTo(mymap);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(mymap);mymap.on("contextmenu",function(a){window.location.hash="#closest-5-"+a.latlng.lat+","+a.latlng.lng})}function centreMap(){mymap.fitBounds([[49.095026,-7.742293],[60.258081000000004,1.847338]])}function displayEvents(b){$.ajax({url:"https://www.parkrun.org.uk/special-events/",async:false}).done(function(c){$specialEvents=$(c);$specialEvents.find("td:nth-child(4):not(:contains(':'))").parent().remove();var d=$geo.find("e");for(var e=0;e<d.length;e++){var f=$(d[e]);var g=parseFloat(f.attr("lo"));var h=parseFloat(f.attr("la"));var i=f.attr("n");if(!isNaN(g)&&!isNaN(h)){if($specialEvents.find("td>a[href='http://www.parkrun.org.uk/"+i+"/'").length>0){addMarker(h,g,name,"green",f);displayedEvents++}}else{console.info("Couldn't find "+i)}}if(displayedEvents>0){mymap.fitBounds(markerGroup.getBounds())}})}function addMarker(j,k,l,m,n){var o=L.icon({iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-"+m+".png",shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});var p=L.marker([j,k],{icon:o});var q;if(typeof n!=="undefined"){var r=n.attr("n");var s=n.attr("r");if(s!=""){var t=$geo.find("r[id="+s+"]").closest("r[u!='']").attr("u")}q='<strong><a target="_blank" href="'+t+"/"+r+'/">'+l+'</a></strong><br /><a target="_blank" href="'+t+"/"+r+'/course/">Course page</a><br /><a target="_blank" href="'+t+"/"+r+'/futureroster/">Future Roster</a><br /><a target="_blank" href="https://www.google.com/maps/dir/?api=1&destination='+j+","+k+'">Directions</a>'}else if(typeof l!=="undefined"){q=l}if(options.vegan){if(typeof q!=="undefined"){q+="<br />"}q+='<a target="_blank" href="https://www.happycow.net/searchmap?lat='+j+"&lng="+k+'&vegan=true">Local vegan food</a>'}p.bindPopup(q);p.addTo(markerGroup)}function filterEvents(u,v){return function(w){var x=[];for(var y=0;y<w.length;y++){var z=$(w[y]);if(v(z)){x.push(z)}}return x}}function load(){$(document).ready(function(){markerGroup.clearLayers();var A=decodeURIComponent(window.location.hash);filters=[];A.split("#").filter(function(B){return B}).forEach(function(C){var D=getFilter(C);if(D!==undefined){filters.push(D)}});displayEvents(filters)})}function init(){$.ajax({url:"./geo.xml",async:false}).done(function(E){$geo=$(E)})}function initAndLoad(){init();load()}
