var mymap;var $geo;var position;var options={};var athleteData=[];var iconColours=["red","orange-dark","orange","yellow","blue-dark","cyan","purple","violet","pink","green-dark","green","green-light","black","white"];var alphabetEvents;Array.prototype.getUnique=function(){var a={},b=[];for(var c=0;c<this.length;c++)a[this[c]]=1;for(var d in a)b.push(d);return b};navigator.geolocation.getCurrentPosition(function(e){position=e;initAndLoad()},function(f){initAndLoad()});$(document).ready(function(){initAjaxPrefilter();initMap();initOptions();centreMap();initAndLoad()});function initAjaxPrefilter(){jQuery.ajaxPrefilter(function(g){if(g.crossDomain&&jQuery.support.cors){g.url="https://cors-anywhere.herokuapp.com/"+g.url}})}function initOptions(){options=JSON.parse(Cookies.get("options")||"{}")}function initMap(){mymap=L.map("mapid",{zoomControl:false,maxBounds:new L.LatLngBounds(new L.LatLng(-90,-180),new L.LatLng(90,180)),minZoom:2});L.control.zoom({position:"topright"}).addTo(mymap);markerGroup=L.featureGroup().addTo(mymap);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(mymap);mymap.on("contextmenu",function(h){window.location.hash="#"+h.latlng.lat+","+h.latlng.lng})}function centreMap(){if(position){mymap.fitBounds([[position.coords.latitude-.01,position.coords.longitude-.01],[position.coords.latitude+.01,position.coords.longitude+.01]])}else{mymap.fitBounds([[49.095026,-7.742293],[60.258081000000004,1.847338]])}}function addMarker(i,j,k,l,m,n){var o=l.substring(0,1);var p=L.ExtraMarkers.icon({markerColor:m,icon:"fa-number",number:o});var q=L.marker([j,k],{icon:p});var r;if(typeof n!=="undefined"){var s=n.attr("n");var t=n.attr("r");if(t!=""){var u=$geo.find("r[id="+t+"]").closest("r[u!='']").attr("u")}r='<strong><a target="_blank" href="'+u+"/"+s+'/">'+l+'</a></strong><br /><a target="_blank" href="'+u+"/"+s+'/course/">Course page</a><br /><a target="_blank" href="https://www.google.com/maps/dir/?api=1&destination='+j+","+k+'">Directions</a>'}else if(typeof l!=="undefined"){r=l}if(options.vegan){if(typeof r!=="undefined"){r+="<br />"}r+='<a target="_blank" href="https://www.happycow.net/searchmap?lat='+j+"&lng="+k+'&vegan=true">Local vegan food</a>'}q.bindPopup(r);q.addTo(markerGroup)}function displayEvents(v){if(typeof v!=="undefined"&&v.substring(1).indexOf(",")>-1){v=v.substring(1);if(v.substring(1).indexOf(",")>-1){var w=v.split(",");closestLatitude=w[0];closestLongitude=w[1]}}else if(typeof position!=="undefined"){closestLatitude=position.coords.latitude;closestLongitude=position.coords.longitude}else{closestLatitude=0;closestLongitude=0}var x=[];var y=[];var z=[];$geo.find('e[lo!=""][la!=""]').each(function(){var H=$(this);var I=parseFloat(H.attr("lo"));var J=parseFloat(H.attr("la"));var K=getDistanceFromLatLonInKm(J,I,closestLatitude,closestLongitude);y.push({id:H.attr("id"),distance:K})});z=y.sort(function(M,N){return M.distance-N.distance});delete y;for(var A=0;A<z.length;A++){x.push(z[A].id)}delete z;if(typeof(options.athleteId==="string")){if(typeof athleteData[options.athleteId]==="undefined"){$.ajax({url:"https://www.parkrun.org.uk:443/results/athleteeventresultshistory/?athleteNumber="+options.athleteId+"&eventNumber=0",async:false}).done(function(O){athleteData[options.athleteId]=$(O)})}}var B=athleteData[options.athleteId].find("tbody a[href$='/results']");alphabetEvents={};for(var A=B.length;A>0;A--){var C=B[A-1].innerHTML;var D=C.substring(0,1).toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");if(typeof alphabetEvents[D]==="undefined"){alphabetEvents[D]=C}}var E=0;x.forEach(function(P){$event=$geo.find("e[id='"+P+"']");var Q=$event.attr("m");var R=Q.substring(0,1).toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");if(alphabetEvents[R]==Q){addMarker(++E,$event.attr("la"),$event.attr("lo"),Q,"purple",$event)}else if(typeof alphabetEvents[R]==="undefined"&&typeof position!=="undefined"){alphabetEvents[R]=Q;addMarker(++E,$event.attr("la"),$event.attr("lo"),Q,"orange",$event)}});var F=L.icon({iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png",shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});var G=L.marker([closestLatitude,closestLongitude],{icon:F});G.addTo(markerGroup);mymap.fitBounds(markerGroup.getBounds())}function getDistanceFromLatLonInKm(S,T,U,V){var W=6371;var X=deg2rad(U-S);var Y=deg2rad(V-T);var Z=Math.sin(X/2)*Math.sin(X/2)+Math.cos(deg2rad(S))*Math.cos(deg2rad(U))*Math.sin(Y/2)*Math.sin(Y/2);var _=2*Math.atan2(Math.sqrt(Z),Math.sqrt(1-Z));var aa=W*_;return aa}function deg2rad(ba){return ba*(Math.PI/180)}function load(){$(document).ready(function(){markerGroup.clearLayers();var ca=decodeURIComponent(window.location.hash);displayEvents(ca)})}function init(){$(window).bind("hashchange",function(da){load()});$.ajax({url:"https://www.parkrun.org.uk/wp-content/themes/parkrun/xml/geo.xml",async:false}).done(function(ea){$geo=$(ea)})}function initAndLoad(){init();load()}
