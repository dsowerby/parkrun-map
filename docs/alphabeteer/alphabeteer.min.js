var mymap;var events;var position;var options={};var athleteData=[];var iconColours=["red","orange-dark","orange","yellow","blue-dark","cyan","purple","violet","pink","green-dark","green","green-light","black","white"];var alphabetEvents;function parseName(a){if(typeof a!=="undefined"){return a.properties.EventLongName}return undefined}function parseEventId(b){if(typeof b!=="undefined"){return b.properties.eventname}return undefined}function parseLongitude(c){if(typeof c!=="undefined"){return parseFloat(c.geometry.coordinates[0])}return undefined}function parseLatitude(d){if(typeof d!=="undefined"){return parseFloat(d.geometry.coordinates[1])}return undefined}function parseCountrycode(e){if(typeof e!=="undefined"){return e.properties.countrycode}return undefined}function parseEventUrl(f){var g=parseEventId(f);var h=parseCountrycode(f);var i=countries[h];return"//"+i.url+"/"+g}function parseSeriesId(j){return j.properties.seriesid}Array.prototype.getUnique=function(){var k={},l=[];for(var m=0;m<this.length;m++)k[this[m]]=1;for(var n in k)l.push(n);return l};navigator.geolocation.getCurrentPosition(function(o){position=o;console.info("loaded");initAndLoad()},function(p){console.info("failed");initAndLoad()});$(document).ready(function(){initMap();initOptions();centreMap();initAndLoad()});function initOptions(){options=JSON.parse(Cookies.get("options")||"{}")}function initMap(){mymap=L.map("mapid",{zoomControl:false,maxBounds:new L.LatLngBounds(new L.LatLng(-90,-180),new L.LatLng(90,180)),minZoom:2});L.control.zoom({position:"topright"}).addTo(mymap);markerGroup=L.featureGroup().addTo(mymap);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(mymap);mymap.on("contextmenu",function(q){window.location.hash="#"+q.latlng.lat+","+q.latlng.lng})}function centreMap(){if(position){mymap.fitBounds([[position.coords.latitude-.01,position.coords.longitude-.01],[position.coords.latitude+.01,position.coords.longitude+.01]])}else{mymap.fitBounds([[49.095026,-7.742293],[60.258081000000004,1.847338]])}}function addMarker(r,s,t,u,v,w){console.info("eventNamePrefix: "+r);var x=L.ExtraMarkers.icon({markerColor:v,icon:"fa-number",number:r});var y=L.marker([s,t],{icon:x});var z;if(typeof w!=="undefined"){var A=parseEventUrl(event);z='<strong><a target="_blank" href="'+A+'/">'+u+'</a></strong><br /><a target="_blank" href="'+A+'/course/">Course page</a><br /><a target="_blank" href="https://www.google.com/maps/dir/?api=1&destination='+s+","+t+'">Directions</a>'}else if(typeof u!=="undefined"){z=u}if(options.vegan){if(typeof z!=="undefined"){z+="<br />"}z+='<a target="_blank" href="https://www.happycow.net/searchmap?lat='+s+"&lng="+t+'&vegan=true">Local vegan food</a>'}y.bindPopup(z);y.addTo(markerGroup)}function displayEvents(B){if(typeof B!=="undefined"&&B.substring(1).indexOf(",")>-1){B=B.substring(1);if(B.substring(1).indexOf(",")>-1){var C=B.split(",");closestLatitude=C[0];closestLongitude=C[1]}}else if(typeof position!=="undefined"){closestLatitude=position.coords.latitude;closestLongitude=position.coords.longitude}else{closestLatitude=0;closestLongitude=0}var D=[];var E=[];var F=[];for(var G=0;G<events;G++){var H=events[G];var I=parseLongitude(H);var J=parseLatitideu(H);var K=getDistanceFromLatLonInKm(J,I,closestLatitude,closestLongitude);E.push({event:H,distance:K})}F=E.sort(function(T,U){return T.distance-U.distance});delete E;var M=[];for(var G=0;G<F.length;G++){M.push(F[G])}delete F;if(typeof(options.athleteId==="string")){if(typeof athleteData[options.athleteId]==="undefined"){$.ajax({url:"https://cors-anywhere.herokuapp.com/https://www.parkrun.org.uk:443/results/athleteeventresultshistory/?athleteNumber="+options.athleteId+"&eventNumber=0",async:false}).done(function(V){athleteData[options.athleteId]=$(V)})}}var N=athleteData[options.athleteId].find("tbody a[href$='/results']");alphabetEvents={};for(var G=N.length;G>0;G--){var O=N[G-1].innerHTML;var P=O.substring(0,1).toUpperCase();if(typeof alphabetEvents[P]==="undefined"){alphabetEvents[P]=O}else if(typeof alphabetEvents[P+"1"]==="undefined"&&options.double){alphabetEvents[P+"1"]=O}}var Q=0;M.forEach(function(W){var X=W.event;var Y=parseName(X);var Z=Y.substring(0,1).toUpperCase();if(alphabetEvents[Z]==Y){addMarker(Z,parseEventLatitude(X),parseEventLongitutde(X),Y,"purple",$event)}else if(alphabetEvents[Z+"1"]==Y&&options.double){addMarker(Z+"1",parseEventLatitude(X),parseEventLongitutde(X),Y,"purple",$event)}else if(typeof alphabetEvents[Z]==="undefined"&&typeof position!=="undefined"){alphabetEvents[Z]=Y;addMarker(Z,parseEventLatitude(X),parseEventLongitutde(X),Y,"orange",$event)}else if(typeof alphabetEvents[Z+"1"]==="undefined"&&typeof position!=="undefined"&&options.double){alphabetEvents[Z+"1"]=Y;addMarker(Z+"1",parseEventLatitude(X),parseEventLongitutde(X),Y,"orange",$event)}});var R=L.icon({iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png",shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});var S=L.marker([closestLatitude,closestLongitude],{icon:R});S.addTo(markerGroup);mymap.fitBounds(markerGroup.getBounds())}function getDistanceFromLatLonInKm(_,aa,ba,ca){var da=6371;var ea=deg2rad(ba-_);var fa=deg2rad(ca-aa);var ga=Math.sin(ea/2)*Math.sin(ea/2)+Math.cos(deg2rad(_))*Math.cos(deg2rad(ba))*Math.sin(fa/2)*Math.sin(fa/2);var ha=2*Math.atan2(Math.sqrt(ga),Math.sqrt(1-ga));var ia=da*ha;return ia}function deg2rad(ja){return ja*(Math.PI/180)}function load(){$(document).ready(function(){markerGroup.clearLayers();var ka=decodeURIComponent(window.location.hash);displayEvents(ka)})}function init(){$(window).bind("hashchange",function(la){load()});$.ajax({url:"../events.json",async:false}).done(function(ma){events=ma})}function initAndLoad(){init();load()}
