var mymap;var markerGroup;var $geo;var options;var athleteData=[];var filters=[];var position;var hamburger;var regionFilter;var withinFilter;var closestFilter;var events;$(document).ready(function(){initOptions();initMap();initBurger();centreMap();initAndLoad()});navigator.geolocation.getCurrentPosition(function(a){position=a;initAndLoad()},function(b){initAndLoad()});function initOptions(){options=JSON.parse(Cookies.get("options")||"{}")}function initBurger(){hamburger={navToggle:document.querySelector(".nav-toggle"),nav:document.querySelector(".nav"),doToggle:function(c){c.preventDefault();this.navToggle.classList.toggle("expanded");this.nav.classList.toggle("expanded")},show:function(){this.navToggle.classList.add("expanded");this.nav.classList.add("expanded")},hide:function(){this.navToggle.classList.remove("expanded");this.nav.classList.remove("expanded")}};hamburger.navToggle.addEventListener("click",function(d){hamburger.doToggle(d)})}function initMap(){mymap=L.map("mapid",{fullscreenControl:true,fullscreenControlOptions:{position:"topright"},zoomControl:false,maxBounds:new L.LatLngBounds(new L.LatLng(-90,-180),new L.LatLng(90,180)),minZoom:2});L.control.zoom({position:"topright"}).addTo(mymap);markerGroup=L.featureGroup().addTo(mymap);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(mymap);mymap.on("contextmenu",function(e){window.location.hash="#closest-5-"+e.latlng.lat+","+e.latlng.lng})}function centreMap(){if(position){mymap.fitBounds([[position.coords.latitude-.01,position.coords.longitude-.01],[position.coords.latitude+.01,position.coords.longitude+.01]])}else{mymap.fitBounds([[49.095026,-7.742293],[60.258081000000004,1.847338]])}}function displayEvents(f){if(f.length==0){return}var g=0;var h=$geo.find('e[lo!=""][la!=""]');console.info("initial size: "+h.length);console.info("processing with "+f.length+" filters");for(var i=0;i<f.length;i++){var j=[];var k=f[i];h=k(h);console.info("after filter "+i+" there are "+h.length+" events")}if(f.length>0){if(!(regionFilter||withinFilter||closestFilter)){var l=$(".countries input:checked");if(l.length>0){var m="or-";for(var n=1;n<l.length;n++){m+="region-"+$(l[n]).attr("name");if(n<l.length){m+="||"}}console.info("filter "+k.length+" "+m);h=getFilter(m)(h);console.info("after filter "+f.length+" there are "+h.length+" events")}}console.info("after all filters there are "+h.length+" events")}window.events=h;for(var o=0;o<h.length;o++){var p=$(h[o]);var q=parseFloat(p.attr("lo"));var r=parseFloat(p.attr("la"));var s=p.attr("m");addMarker(r,q,s,"blue",p);g++}if(g>0){mymap.fitBounds(markerGroup.getBounds());hamburger.hide();console.info(g+" events displayed")}else{hamburger.show();console.info("no events displayed")}}function addMarker(t,u,v,w,x){var y=L.icon({iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-"+w+".png",shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});var z=L.marker([t,u],{icon:y});var A;if(typeof x!=="undefined"){var B=x.attr("n");var C=x.attr("r");if(C!=""){var D=$geo.find("r[id="+C+"]").closest("r[u!='']").attr("u")}A='<strong><a target="_blank" href="'+D+"/"+B+'/">'+v+'</a></strong><br /><a target="_blank" href="'+D+"/"+B+'/course/">Course page</a><br /><a target="_blank" href="'+D+"/"+B+'/futureroster/">Future Roster</a><br /><a target="_blank" href="https://www.google.com/maps/dir/?api=1&destination='+t+","+u+'">Directions</a>'}else if(typeof v!=="undefined"){A=v}if(typeof A!=="undefined"){A+="<br />"}A+='<a target="_blank" href="https://www.happycow.net/searchmap?lat='+t+"&lng="+u+'&vegan=true">Local vegan food</a>';if(options.nationaltrust){if(typeof A!=="undefined"){A+="<br />"}A+='<a target="_blank" href="https://www.nationaltrust.org.uk/search?lat='+t+"&lon="+u+'&type=place&view=map">National Trust venues</a>';A+="<br />";A+='<a target="_blank" href="https://www.nationaltrust.org.uk/search?lat='+t+"&lon="+u+'&type=place&view=map&PlaceFilter=houses-and-buildings">National Trust houses</a>'}if(options.premierinn){if(typeof A!=="undefined"){A+="<br />"}A+='<a target="_blank" href="https://www.premierinn.com/gb/en/search.html?&LOCATION='+t+","+u+'">Local Premier Inns</a>'}z.bindPopup(A);z.addTo(markerGroup)}function filterEvents(E,F){return function(G){var H=[];for(var I=0;I<G.length;I++){var J=$(G[I]);if(F(J)){H.push(J)}}return H}}function getFilter(K){if(K.startsWith("not-")){var M=K.substring(4);var N=getFilter(M);return function(ha){var ia=N(ha);return _.differenceWith(ha,ia,function(ja,ka){return $(ja).attr("id")==$(ka).attr("id")})}}else if(K.startsWith("and-")){var O=K.substring(4);var P=[];O.split("&&").filter(function(la){return la}).forEach(function(ma){P.push(getFilter(ma))});return function(na){var oa=na;for(var pa=0;pa<P.length;pa++){oa=P[pa](oa)}return oa}}else if(K.startsWith("or-")){var Q=K.substring(3);var R=[];Q.split("||").filter(function(qa){return qa}).forEach(function(ra){R.push(getFilter(ra))});return function(sa){orFilterResults=[];for(var ta=0;ta<R.length;ta++){orFilterResults=_.union(orFilterResults,R[ta](sa))}return orFilterResults}}else if(K.startsWith("startsWith-")){var S=K.substring(11);return filterEvents(events,function(ua){var va=ua.attr("m");return va.toLowerCase().startsWith(S.toLowerCase())})}else if(K.startsWith("contains-")){var T=K.substring(9);return filterEvents(events,function(wa){var xa=wa.attr("m");return xa.toLowerCase().indexOf(T.toLowerCase())>-1})}else if(K.startsWith("matches-")){var U=K.substring(8);var V=new RegExp(U,"i");return filterEvents(events,function(ya){var za=ya.attr("m");return V.test(za.toLowerCase())})}else if(K.startsWith("region-")){regionFilter=true;var W=K.substring(7);var X=$geo.find("r[n='"+W+"']");return filterEvents(events,function(Aa){var Ba=Aa.attr("r");return X.is('[id="'+Ba+'"]')||X.has('r[id="'+Ba+'"]').length>0})}else if(K.startsWith("athlete")){var Y;if(K=="athlete"){Y=options.athleteId}else{Y=K.substring(8)}if(typeof athleteData[Y]==="undefined"){$.ajax({url:"https://cors-anywhere.herokuapp.com/http://www.parkrun.org.uk/results/athleteeventresultshistory/?athleteNumber="+Y+"&eventNumber=0",async:false}).done(function(Ca){athleteData[Y]=$(Ca)})}return filterEvents(events,function(Da){return athleteData[Y].find("a[href$='/"+Da.attr("n")+"/results']").length>0})}else if(K.startsWith("within-")){withinFilter=true;var Z=K.substring(7);var aa,ba,ca;if(isNaN(Z)){var da=Z.indexOf("-");aa=Z.substring(0,da);var ea=Z.substring(da+1).split(",");ba=ea[0];ca=ea[1]}else{aa=parseInt(K.substring(7));if(position===undefined){aa=0;ba=0;ca=0}else{ba=position.coords.latitude;ca=position.coords.longitude}}addMarker(ba,ca,"Within "+aa+"km","orange");return filterEvents(events,function(Ea){var Fa=parseFloat(Ea.attr("lo"));var Ga=parseFloat(Ea.attr("la"));return getDistanceFromLatLonInKm(Ga,Fa,ba,ca)<aa})}else if(K=="compass"){return function(Ha){var Ia={};var Ja={};var Ka={};var La={};for(var Ma=0;Ma<Ha.length;Ma++){var Na=$(this);var Na=$(Ha[Ma]);var Oa=parseFloat(Na.attr("lo"));var Pa=parseFloat(Na.attr("la"));if(isNaN(Ia.latitude)||Ia.latitude<Pa){Ia.longitude=Oa;Ia.latitude=Pa;Ia.id=Na.attr("id");Ia.event=Na}if(isNaN(Ka.longitude)||Ka.longitude<Oa){Ka.longitude=Oa;Ka.latitude=Pa;Ka.id=Na.attr("id");Ka.event=Na}if(isNaN(Ja.latitude)||Ja.latitude>Pa){Ja.longitude=Oa;Ja.latitude=Pa;Ja.id=Na.attr("id");Ja.event=Na}if(isNaN(La.longitude)||La.longitude>Oa){La.longitude=Oa;La.latitude=Pa;La.id=Na.attr("id");La.event=Na}}var Ha=[Ia.event,Ka.event,Ja.event,La.event];console.info(Ha);return _.uniq(Ha)}}else if(K.startsWith("closest")){closestFilter=true;var fa=K.substring(8);if(isNaN(fa)){var da=fa.indexOf("-");var ga=fa.substring(da+1).split(",");closestLatitude=ga[0];closestLongitude=ga[1];delete ga;fa=fa.substring(0,da)}else{if(position===undefined){fa=0;closestLatitude=0;closestLongitude=0}else{if(position===undefined){fa=0;closestLatitude=0;closestLongitude=0}else{fa=parseInt(K.substring(8));closestLatitude=position.coords.latitude;closestLongitude=position.coords.longitude}}}return function(Qa){var Ra=[];for(var Sa=0;Sa<Qa.length;Sa++){$event=$(Qa[Sa]);var Ta=parseFloat($event.attr("lo"));var Ua=parseFloat($event.attr("la"));var Va=getDistanceFromLatLonInKm(Ua,Ta,closestLatitude,closestLongitude);Ra.push({event:$event,distance:Va})}var Wa=Ra.sort(function(Za,$a){return Za.distance-$a.distance});var Xa=[];if(Ra.length<fa){fa=Ra.length}addMarker(closestLatitude,closestLongitude,"Closest "+fa+" event ","green");for(var Ya=0;Ya<fa;Ya++){Xa.push(Ra[Ya].event)}return Xa}}else if(K=="random"){return function(_a){var ab=_.random(_a.length-1);return[$(_a[ab])]}}else if(K==="none"){return filterEvents(events,function(bb){return[]})}else if(K==="all"){return function(cb){return cb}}}function getDistanceFromLatLonInKm(db,eb,fb,gb){var hb=6371;var ib=deg2rad(fb-db);var jb=deg2rad(gb-eb);var kb=Math.sin(ib/2)*Math.sin(ib/2)+Math.cos(deg2rad(db))*Math.cos(deg2rad(fb))*Math.sin(jb/2)*Math.sin(jb/2);var lb=2*Math.atan2(Math.sqrt(kb),Math.sqrt(1-kb));var mb=hb*lb;return mb}function deg2rad(nb){return nb*(Math.PI/180)}function load(){$(document).ready(function(){markerGroup.clearLayers();var ob=decodeURIComponent(window.location.hash);filters=[];regionFilter=false;withinFilter=false;closestFilter=false;var pb=0;ob.split("#").filter(function(qb){return qb}).forEach(function(rb){console.info("filter "+pb+" "+rb);var sb=getFilter(rb);if(sb!==undefined){filters.push(sb)}pb++});displayEvents(filters)})}function init(){$(window).bind("hashchange",function(tb){load()});$.ajax({url:"./geo.xml",async:false}).done(function(ub){$geo=$(ub);var vb=$('<div class="countries"><h4>Countries</h4></div>');$(".nav .controls").append(vb);$geo.find("r[id=1] > r").each(function(){var wb=$(this);var xb=wb.attr("id");var yb=wb.attr("n");var zb=$("<input type='checkbox' />");zb.attr("name",yb);if(yb=="UK"){zb.attr("checked","")}zb.attr("data-region-id-"+xb,"");$geo.find("r[id="+xb+"] r").each(function(){$region=$(this);zb.attr("data-region-id-"+$region.attr("id"),"")});vb.append(zb).append($("<span />").text(yb)).append($("<br />"));zb.change(function(){load()})})});$("#letter-prefix").keypress(function(Ab){if(Ab.which==13){var Bb=$("#letter-prefix").val();var Bb=Array.from(new Set(Bb.toLowerCase().replace(/[^a-z]/gi,"").split(""))).join("");window.location.hash="#matches-^["+Bb+"]"}});$("#search").keypress(function(Cb){if(Cb.which==13){var Db=$("#search").val();window.location.hash="#matches-.*"+Db+".*"}})}function initAndLoad(){init();load()}
