var mymap;var markerGroup;var $geo;var options;var athleteData=[];var filters=[];var position;var hamburger;var withinFilter;var closestFilter;var events;var xmas;var nyd;var cancelled;var specialEvents;function parseName(a){if(typeof a!=="undefined"){return a.properties.EventLongName}return undefined}function parseEventId(b){if(typeof b!=="undefined"){return b.properties.eventname}return undefined}function parseLongitude(c){if(typeof c!=="undefined"){return parseFloat(c.geometry.coordinates[0])}return undefined}function parseLatitude(d){if(typeof d!=="undefined"){return parseFloat(d.geometry.coordinates[1])}return undefined}function parseCountrycode(e){if(typeof e!=="undefined"){return e.properties.countrycode}return undefined}function parseEventUrl(f){var g=parseEventId(f);var h=parseCountrycode(f);var i=countries[h];return"//"+i.url+"/"+g}function parseSeriesId(j){return j.properties.seriesid}$(document).ready(function(){initOptions();initMap();initBurger();centreMap();initAndLoad()});navigator.geolocation.getCurrentPosition(function(k){position=k;initAndLoad()},function(l){console.info("Error looking up location"+l);initAndLoad()});function initOptions(){options=JSON.parse(Cookies.get("options")||"{}")}function initBurger(){hamburger={navToggle:document.querySelector(".nav-toggle"),nav:document.querySelector(".nav"),doToggle:function(m){m.preventDefault();this.navToggle.classList.toggle("expanded");this.nav.classList.toggle("expanded")},show:function(){this.navToggle.classList.add("expanded");this.nav.classList.add("expanded")},hide:function(){this.navToggle.classList.remove("expanded");this.nav.classList.remove("expanded")}};hamburger.navToggle.addEventListener("click",function(n){hamburger.doToggle(n)})}function initMap(){mymap=L.map("mapid",{fullscreenControl:true,fullscreenControlOptions:{position:"topright"},zoomControl:false,maxBounds:new L.LatLngBounds(new L.LatLng(-90,-180),new L.LatLng(90,180)),minZoom:2});L.control.zoom({position:"topright"}).addTo(mymap);markerGroup=L.featureGroup().addTo(mymap);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(mymap);mymap.on("contextmenu",function(o){window.location.hash="#closest-5-"+o.latlng.lat+","+o.latlng.lng})}function centreMap(){if(position){mymap.fitBounds([[position.coords.latitude-.01,position.coords.longitude-.01],[position.coords.latitude+.01,position.coords.longitude+.01]])}else{mymap.fitBounds([[49.095026,-7.742293],[60.258081000000004,1.847338]])}}function displayEvents(p){if(p.length==0){return}var q=0;var r=$events.features;console.info("initial size: "+r.length);console.info("processing with "+p.length+" filters");for(var s=0;s<p.length;s++){var t=[];var u=p[s];r=u(r);console.info("after filter "+s+" there are "+r.length+" events")}if(p.length>0){console.info("after all filters there are "+r.length+" events")}window.events=r;for(var v=0;v<r.length;v++){var w=r[v];var x=parseLongitude(w);var y=parseLatitude(w);var z=parseName(w);addMarker(y,x,z,"blue",w);q++}if(q>0){mymap.fitBounds(markerGroup.getBounds());hamburger.hide();console.info(q+" events displayed")}else{hamburger.show();console.info("no events displayed")}}function addMarker(A,B,C,D,E){var F=L.icon({iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-"+D+".png",shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});var G=L.marker([A,B],{icon:F});var H;if(typeof E!=="undefined"){var I=parseEventUrl(E);H='<strong><a target="_blank" href="'+I+'/">'+C+"</a></strong><br />";H+='<a target="_blank" href="'+I+'/course/">Course page</a><br />';H+='<a target="_blank" href="'+I+'/futureroster/">Future Roster</a><br />';H+='<a target="_blank" href="'+I+'/results/eventhistory/">Event History</a><br />';H+='<a target="_blank" href="https://www.google.com/maps/dir/?api=1&destination='+A+","+B+'">Directions</a><br />';H+='<a target="_blank" href="./weather#'+A+","+B+'">Weather Forecast</a><br />';H+='<a target="_blank" href="https://www.facebook.com/search/top/?q='+C+'&epa=SEARCH_BOX">Facebook</a><br />';H+='<a target="_blank" href="https://www.youtube.com/results?search_query='+C+'">YouTube</a>'}else if(typeof C!=="undefined"){H=C}{if(typeof H!=="undefined"){H+="<br />"}H+='<a target="_blank" href="https://www.happycow.net/searchmap?lat='+A+"&lng="+B+'&vegan=true">Local vegan food</a>'}{if(typeof H!=="undefined"){H+="<br />"}H+='<a target="_blank" href="https://www.nationaltrust.org.uk/search?lat='+A+"&lon="+B+'&type=place&view=map">National Trust venues</a>';H+="<br />";H+='<a target="_blank" href="https://www.nationaltrust.org.uk/search?lat='+A+"&lon="+B+'&type=place&view=map&PlaceFilter=houses-and-buildings">National Trust houses</a>'}{if(typeof H!=="undefined"){H+="<br />"}H+='<a target="_blank" href="https://www.premierinn.com/gb/en/search.html?&LOCATION='+A+","+B+'">Local Premier Inns</a>'}{if(typeof H!=="undefined"){H+="<br />"}H+='<a target="_blank" href="https://www.pitchup.com/search/?sort=&lat='+A+"&lng="+B+'&facet=toilet-block&facet=adults-only&facet=shower-available&within=40&q=&type=4&adults=2&children=0">Tent site</a>'}G.bindPopup(H);G.addTo(markerGroup)}function filterEvents(J,K){return function(M){var N=[];for(var O=0;O<M.length;O++){var P=M[O];if(K(P)){N.push(P)}}return N}}function getFilter(Q){if(Q.startsWith("seriesid")){var R=Q.substring(9);return filterEvents(events,function(pa){var qa=parseSeriesId(pa);return qa==R})}else if(Q.startsWith("not-")){var S=Q.substring(4);var T=getFilter(S);return function(ra){var sa=T(ra);return _.differenceWith(ra,sa,function(ta,ua){return parseEventId(ta)==parseEventId(ua)})}}else if(Q.startsWith("and-")){var U=Q.substring(4);var V=[];U.split("&&").filter(function(va){return va}).forEach(function(wa){V.push(getFilter(wa))});return function(xa){var ya=xa;for(var za=0;za<V.length;za++){ya=V[za](ya)}return ya}}else if(Q.startsWith("or-")){var W=Q.substring(3);var X=[];W.split("||").filter(function(Aa){return Aa}).forEach(function(Ba){X.push(getFilter(Ba))});return function(Ca){orFilterResults=[];for(var Da=0;Da<X.length;Da++){orFilterResults=_.union(orFilterResults,X[Da](Ca))}return orFilterResults}}else if(Q.startsWith("startsWith-")){var Y=Q.substring(11);return filterEvents(events,function(Ea){var Fa=parseName(Ea);return Fa.toLowerCase().startsWith(Y.toLowerCase())||Fa.toLowerCase().startsWith("parkrun "+Y.toLowerCase())})}else if(Q.startsWith("contains-")){var Z=Q.substring(9);return filterEvents(events,function(Ga){var Ha=parseName(Ga);return Ha.toLowerCase().indexOf(Z.toLowerCase())>-1})}else if(Q.startsWith("matches-")){var aa=Q.substring(8);var ba=new RegExp(aa,"i");return filterEvents(events,function(Ia){var Ja=parseName(Ia);return ba.test(Ja.toLowerCase())})}else if(Q.startsWith("country-")){var ca=Q.substring(8);var da;switch(ca.toLowerCase()){case"austria":case"at":da=4;break;case"australia":case"au":da=3;break;case"canada":case"ca":da=14;break;case"denmark":case"dk":da=23;break;case"finland":case"fi":da=30;break;case"france":case"fr":da=31;break;case"germany":case"de":da=32;break;case"ireland":case"ie":da=42;break;case"italy":case"it":da=44;break;case"japan":case"ja":da=46;break;case"malaysia":case"my":da=57;break;case"netherlands":case"nl":da=64;break;case"new-zealand":case"new zealand":case"nz":da=65;break;case"norway":case"no":da=67;break;case"poland":case"pl":da=74;break;case"russia":case"ru":da=79;break;case"singapore":case"sg":da=82;break;case"south africa":case"south-africa":case"za":da=85;break;case"sweden":case"se":da=88;break;case"united kingdom":case"united-kingdom":case"uk":da=97;break;case"united states":case"united-states":case"usa":case"us":da=98;break}return filterEvents(events,function(Ka){return da===parseCountrycode(Ka)})}else if(Q=="cancelled"){if(typeof cancelled==="undefined"){$.ajax({url:"https://cors-anywhere.herokuapp.com/https://www.parkrun.org.uk/cancellations/",async:false}).done(function(La){cancelled=$(La)})}return filterEvents(events,function(Ma){var Na=parseEventUrl(Ma)+"/";return cancelled.find("#main > #primary > #content > div.floatleft.left > ul:nth-child(4), #main > #primary > #content > div.floatleft.left > ul:nth-child(6)").find("li>a[href*='"+Na+"']").length>0})}else if(Q=="nyd"){if(typeof nyd==="undefined"){$.ajax({url:"https://cors-anywhere.herokuapp.com/https://www.parkrun.org.uk/special-events/",async:false}).done(function(Oa){specialEvents=$(Oa);xmas=$(Oa);xmas.find("#content .sortable tbody").addClass("events");xmas.find(".events td:nth-child(3):not(:contains(':'))").parent().remove();xmas.find(".events td>a[href$='/news/tag/newyear']").each(function(Pa,Qa){console.info("xmas "+$(Qa).attr("href"))});nyd=$(Oa);nyd.find("#content .sortable tbody").addClass("events");nyd.find(".events td:nth-child(4):not(:contains(':'))").parent().remove();nyd.find(".events td>a[href$='/news/tag/newyear']").each(function(Ra,Sa){console.info("nyd "+$(Sa).attr("href"))})})}return filterEvents(events,function(Ta){var Ua=parseEventId(Ta);return nyd.find("td>a[href='https://www.parkrun.org.uk/"+Ua+"/']").length>0})}else if(Q=="xmas"){if(typeof xmas==="undefined"){$.ajax({url:"https://cors-anywhere.herokuapp.com/https://www.parkrun.org.uk/special-events/",async:false}).done(function(Va){specialEvents=$(Va);xmas=$(Va);xmas.find("#content .sortable tbody").addClass("events");xmas.find(".events td:nth-child(3):not(:contains(':'))").parent().remove();xmas.find(".events td>a[href$='/news/tag/christmas']").each(function(Wa,Xa){console.info("xmas "+$(Xa).attr("href"))});nyd=$(Va);nyd.find("#content .sortable tbody").addClass("events");nyd.find(".events td:nth-child(4):not(:contains(':'))").parent().remove();nyd.find(".events td>a[href$='/news/tag/newyear']").each(function(Ya,Za){console.info("nyd "+$(Za).attr("href"))})})}return filterEvents(events,function($a){var _a=parseEventId($a);return xmas.find("td>a[href='https://www.parkrun.org.uk/"+_a+"/']").length>0})}else if(Q.startsWith("athlete")){var ea;if(Q=="athlete"){ea=options.athleteId}else{ea=Q.substring(8).trim();if(ea.toUpperCase().startsWith("A")){ea=ea.substring(1)}}if(typeof athleteData[ea]==="undefined"){$.ajax({url:"./athletes/"+ea+".json",async:false}).done(function(a0){athleteData[ea]=a0})}return filterEvents(events,function(b0){var c0=parseEventId(b0);return athleteData[ea].includes(c0)})}else if(Q.startsWith("within-")){withinFilter=true;var fa=Q.substring(7);var ga,ha,ia;if(isNaN(fa)){var ja=fa.indexOf("-");ga=fa.substring(0,ja);var ka=fa.substring(ja+1).split(",");ha=ka[0];ia=ka[1]}else{ga=parseInt(Q.substring(7));if(position===undefined){ga=0;ha=0;ia=0}else{ha=position.coords.latitude;ia=position.coords.longitude}}addMarker(ha,ia,"Within "+ga+"km","orange");return filterEvents(events,function(d0){var e0=parseLatitude(d0);var f0=parseLongitude(d0);return getDistanceFromLatLonInKm(e0,f0,ha,ia)<ga})}else if(Q=="compass"){return function(g0){var h0={};var i0={};var j0={};var k0={};for(var l0=0;l0<g0.length;l0++){var m0=g0[l0];var n0=parseLatitude(m0);var o0=parseLongitude(m0);if(isNaN(h0.latitude)||h0.latitude<n0){h0.longitude=o0;h0.latitude=n0;h0.id=parseEventId(m0);h0.event=m0}if(isNaN(j0.longitude)||j0.longitude<o0){j0.longitude=o0;j0.latitude=n0;j0.id=parseEventId(m0);j0.event=m0}if(isNaN(i0.latitude)||i0.latitude>n0){i0.longitude=o0;i0.latitude=n0;i0.id=parseEventId(m0);i0.event=m0}if(isNaN(k0.longitude)||k0.longitude>o0){k0.longitude=o0;k0.latitude=n0;k0.id=parseEventId(m0);k0.event=m0}}var g0=[h0.event,j0.event,i0.event,k0.event];return _.uniq(g0)}}else if(Q.startsWith("closest")){closestFilter=true;var la=Q.substring(8);if(isNaN(la)){var ja=la.indexOf("-");var ma=la.substring(ja+1).split(",");closestLatitude=ma[0];closestLongitude=ma[1];delete ma;la=la.substring(0,ja)}else{if(position===undefined){la=0;closestLatitude=0;closestLongitude=0}else{if(position===undefined){la=0;closestLatitude=0;closestLongitude=0}else{la=parseInt(Q.substring(8));closestLatitude=position.coords.latitude;closestLongitude=position.coords.longitude}}}return function(p0){var q0=[];for(var r0=0;r0<p0.length;r0++){$event=p0[r0];var s0=parseLatitude($event);var t0=parseLongitude($event);var u0=getDistanceFromLatLonInKm(s0,t0,closestLatitude,closestLongitude);q0.push({event:$event,distance:u0})}var v0=q0.sort(function(y0,z0){return y0.distance-z0.distance});var w0=[];if(q0.length<la){la=q0.length}addMarker(closestLatitude,closestLongitude,"Closest "+la+" event ","green");for(var x0=0;x0<la;x0++){w0.push(q0[x0].event)}return w0}}else if(Q=="random"){return function(A0){var B0=_.random(A0.length-1);return[A0[B0]]}}else if(Q==="none"){return filterEvents(events,function(C0){return[]})}else if(Q==="all"){return function(D0){return D0}}else if(Q.startsWith("pin-")){var na=Q.substring(4);var ja=na.indexOf("-");pinColour=na.substring(0,ja);var oa=na.substring(ja+1).split(",");pinLatitude=oa[0];pinLongitude=oa[1];addMarker(pinLatitude,pinLongitude,"Pinned location",pinColour);return function(E0){return E0}}}function getDistanceFromLatLonInKm(F0,G0,H0,I0){var J0=6371;var K0=deg2rad(H0-F0);var L0=deg2rad(I0-G0);var M0=Math.sin(K0/2)*Math.sin(K0/2)+Math.cos(deg2rad(F0))*Math.cos(deg2rad(H0))*Math.sin(L0/2)*Math.sin(L0/2);var N0=2*Math.atan2(Math.sqrt(M0),Math.sqrt(1-M0));var O0=J0*N0;return O0}function deg2rad(P0){return P0*(Math.PI/180)}function load(){$(document).ready(function(){markerGroup.clearLayers();var Q0=decodeURIComponent(window.location.hash);filters=[];regionFilter=false;withinFilter=false;closestFilter=false;var R0=0;Q0.split("#").filter(function(S0){return S0}).forEach(function(T0){console.info("filter "+R0+" "+T0);var U0=getFilter(T0);if(U0!==undefined){filters.push(U0)}R0++});displayEvents(filters)})}function init(){$(window).bind("hashchange",function(V0){load()});$.ajax({url:"./events.json",async:false}).done(function(W0){$events=W0.events;countries=W0.countries});$("#letter-prefix").keypress(function(X0){if(X0.which==13){var Y0=$("#letter-prefix").val();var Y0=Array.from(new Set(Y0.toLowerCase().replace(/[^a-z]/gi,"").split(""))).join("");window.location.hash="#matches-^["+Y0+"]"}});$("#search").keypress(function(Z0){if(Z0.which==13){var $0=$("#search").val();window.location.hash="#matches-.*"+$0+".*"}});$("#athlete").keypress(function(_0){if(_0.which==13){var ab=$("#athlete").val();window.location.hash="#athlete-"+ab}})}function initAndLoad(){init();load()}
