var mymap;var markerGroup;var $geo;var options;var athleteData=[];var filters=[];var position;var hamburger;var regionFilter;var withinFilter;navigator.geolocation.getCurrentPosition(function(a){position=a;initAndLoad()},function(b){initAndLoad()});$(document).ready(function(){initOptions();initMap();initBurger();centreMap();initAndLoad()});function initOptions(){options=JSON.parse(Cookies.get("options")||"{}")}function initBurger(){hamburger={navToggle:document.querySelector(".nav-toggle"),nav:document.querySelector(".nav"),doToggle:function(c){c.preventDefault();this.navToggle.classList.toggle("expanded");this.nav.classList.toggle("expanded")},show:function(){this.navToggle.classList.add("expanded");this.nav.classList.add("expanded")},hide:function(){this.navToggle.classList.remove("expanded");this.nav.classList.remove("expanded")}};hamburger.navToggle.addEventListener("click",function(d){hamburger.doToggle(d)})}function initMap(){mymap=L.map("mapid",{fullscreenControl:true,fullscreenControlOptions:{position:"topright"},zoomControl:false,maxBounds:new L.LatLngBounds(new L.LatLng(-90,-180),new L.LatLng(90,180)),minZoom:2});L.control.zoom({position:"topright"}).addTo(mymap);markerGroup=L.featureGroup().addTo(mymap);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(mymap);mymap.on("contextmenu",function(e){window.location.hash="#closest-5-"+e.latlng.lat+","+e.latlng.lng})}function centreMap(){if(position){mymap.fitBounds([[position.coords.latitude-.01,position.coords.longitude-.01],[position.coords.latitude+.01,position.coords.longitude+.01]])}else{mymap.fitBounds([[49.095026,-7.742293],[60.258081000000004,1.847338]])}}function displayEvents(f){var g=0;$geo.find("e").each(function(){var h=$(this);var i=h.attr("m");var j=h.attr("r");if(j!=""){var k=$geo.find("r[id="+j+"]").closest("r[u!='']").attr("u")}var l=$("[data-region-id-"+j+"]");var m=l.prop("checked");var n=false;if(m||regionFilter||withinFilter){n=true;for(var o=0;o<f.length;o++){if(n){var p=f[o](h);n=n&&p}}}if(n){var q=parseFloat(h.attr("lo"));var r=parseFloat(h.attr("la"));console.info(h.attr("n")+" "+h.attr("id"));if(!isNaN(q)&&!isNaN(r)){addMarker(r,q,i,"blue",h);g++}}});if(g>0){mymap.fitBounds(markerGroup.getBounds());hamburger.hide();console.info(g+" events displayed")}else{hamburger.show();console.info("no events displayed")}}function addMarker(s,t,u,v,w){var x=L.icon({iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-"+v+".png",shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});var y=L.marker([s,t],{icon:x});var z;if(typeof w!=="undefined"){var A=w.attr("n");var B=w.attr("r");if(B!=""){var C=$geo.find("r[id="+B+"]").closest("r[u!='']").attr("u")}z='<strong><a target="_blank" href="'+C+"/"+A+'/">'+u+'</a></strong><br /><a target="_blank" href="'+C+"/"+A+'/course/">Course page</a><br /><a target="_blank" href="'+C+"/"+A+'/futureroster/">Future Roster</a><br /><a target="_blank" href="https://www.google.com/maps/dir/?api=1&destination='+s+","+t+'">Directions</a>'}else if(typeof u!=="undefined"){z=u}if(options.vegan){if(typeof z!=="undefined"){z+="<br />"}z+='<a target="_blank" href="https://www.happycow.net/searchmap?lat='+s+"&lng="+t+'&vegan=true">Local vegan food</a>'}if(options.nationaltrust){if(typeof z!=="undefined"){z+="<br />"}z+='<a target="_blank" href="https://www.nationaltrust.org.uk/search?lat='+s+"&lon="+t+'&type=place&view=map">National Trust venues</a>';z+="<br />";z+='<a target="_blank" href="https://www.nationaltrust.org.uk/search?lat='+s+"&lon="+t+'&type=place&view=map&PlaceFilter=houses-and-buildings">National Trust houses</a>'}if(options.premierinn){if(typeof z!=="undefined"){z+="<br />"}z+='<a target="_blank" href="https://www.premierinn.com/gb/en/search.html?&LOCATION='+s+","+t+'">Local Premier Inns</a>'}y.bindPopup(z);y.addTo(markerGroup)}function getFilter(D){if(D.startsWith("not-")){var E=D.substring(4);var F=getFilter(E);return function(ha){return!F(ha)}}else if(D.startsWith("and-")){var G=D.substring(4);var H=[];G.split("&&").filter(function(ia){return ia}).forEach(function(ja){H.push(getFilter(ja))});return function(ka){for(var la=0;la<H.length;la++){if(!H[la](ka)){return false}}return true}}else if(D.startsWith("or-")){var I=D.substring(3);var J=[];I.split("||").filter(function(ma){return ma}).forEach(function(na){J.push(getFilter(na))});return function(oa){for(var pa=0;pa<J.length;pa++){if(J[pa](oa)){return true}}return false}}else if(D.startsWith("startsWith-")){var K=D.substring(11);return function(qa){var ra=qa.attr("m");return ra.toLowerCase().startsWith(K.toLowerCase())}}else if(D.startsWith("contains-")){var M=D.substring(9);return function(sa){var ta=sa.attr("m");return ta.toLowerCase().indexOf(M.toLowerCase())>-1}}else if(D.startsWith("matches-")){var N=D.substring(8);var O=new RegExp(N,"i");return function(ua){var va=ua.attr("m");return O.test(va.toLowerCase())}}else if(D.startsWith("region-")){regionFilter=true;var P=D.substring(7);var Q=$geo.find("r[n='"+P+"']");window.regionElement=Q;return function(wa){var xa=wa.attr("r");return Q.is('[id="'+xa+'"]')||Q.has('r[id="'+xa+'"]').length>0}}else if(D.startsWith("athlete")){var R;if(D=="athlete"){R=options.athleteId}else{R=D.substring(8)}if(typeof athleteData[R]==="undefined"){$.ajax({url:"https://cors-anywhere.herokuapp.com/http://www.parkrun.org.uk/results/athleteeventresultshistory/?athleteNumber="+R+"&eventNumber=0",async:false}).done(function(ya){athleteData[R]=$(ya)})}return function(za){return athleteData[R].find("a[href$='/"+za.attr("n")+"/results']").length>0}}else if(D.startsWith("within-")){withinFilter=true;var S=D.substring(7);var T,U,V;if(isNaN(S)){var W=S.indexOf("-");T=S.substring(0,W);var X=S.substring(W+1).split(",");U=X[0];V=X[1]}else{T=parseInt(D.substring(7));if(position===undefined){T=0;U=0;V=0}else{U=position.coords.latitude;V=position.coords.longitude}}addMarker(U,V,"Within "+T+"km","orange");return function(Aa){var Ba=parseFloat(Aa.attr("lo"));var Ca=parseFloat(Aa.attr("la"));return getDistanceFromLatLonInKm(Ca,Ba,U,V)<T}}else if(D.equals("closest")){var Y={};var Z={};var _={};var aa={};$geo.find('e[lo!=""][la!=""]').each(function(){var Da=$(this);var Ea=parseFloat(Da.attr("lo"));var Fa=parseFloat(Da.attr("la"));if(isNaN(Y.latitude)||Y.latitude<Fa){Y.longitude=Ea;Y.latitude=Fa;Y.id=Da.attr("id")}if(isNaN(_.longitude)||_.longitude<Ea){_.longitude=Ea;_.latitude=Fa;_.id=Da.attr("id")}if(isNaN(Z.latitude)||Z.latitude>Fa){Z.longitude=Ea;Z.latitude=Fa;Z.id=Da.attr("id")}if(isNaN(aa.longitude)||aa.longitude>Ea){aa.longitude=Ea;aa.latitude=Fa;aa.id=Da.attr("id")}});return function(Ga){var Ha=Ga.attr("id");return Ha==Y.id||Ha==_.id||Ha==Z.id||Ha==aa.id}}else if(D.startsWith("compass")){withinFilter=true;var ba=D.substring(8);if(isNaN(ba)){var W=ba.indexOf("-");var ca=ba.substring(W+1).split(",");closestLatitude=ca[0];closestLongitude=ca[1];delete ca;ba=ba.substring(0,W)}else{if(position===undefined){ba=0;closestLatitude=0;closestLongitude=0}else{if(position===undefined){ba=0;closestLatitude=0;closestLongitude=0}else{ba=parseInt(D.substring(8));closestLatitude=position.coords.latitude;closestLongitude=position.coords.longitude}}}var da=[];var ea=[];var fa=[];console.info("Looking for the closest "+ba+" events to "+closestLatitude+","+closestLongitude);$geo.find('e[lo!=""][la!=""]').each(function(){var Ia=$(this);var Ja=parseFloat(Ia.attr("lo"));var Ka=parseFloat(Ia.attr("la"));var La=getDistanceFromLatLonInKm(Ka,Ja,closestLatitude,closestLongitude);ea.push({id:Ia.attr("id"),distance:La})});fa=ea.sort(function(Ma,Na){return Ma.distance-Na.distance}).slice(0,ba);delete ea;for(var ga=0;ga<fa.length;ga++){da.push(fa[ga].id)}delete fa;addMarker(closestLatitude,closestLongitude,"Closest "+ba+" event ","green");return function(Oa){return da.indexOf(Oa.attr("id"))>-1}}else if(D==="none"){return function(){return false}}else if(D==="all"){return function(){return true}}}function getDistanceFromLatLonInKm(Pa,Qa,Ra,Sa){var Ta=6371;var Ua=deg2rad(Ra-Pa);var Va=deg2rad(Sa-Qa);var Wa=Math.sin(Ua/2)*Math.sin(Ua/2)+Math.cos(deg2rad(Pa))*Math.cos(deg2rad(Ra))*Math.sin(Va/2)*Math.sin(Va/2);var Xa=2*Math.atan2(Math.sqrt(Wa),Math.sqrt(1-Wa));var Ya=Ta*Xa;return Ya}function deg2rad(Za){return Za*(Math.PI/180)}function load(){$(document).ready(function(){markerGroup.clearLayers();var $a=decodeURIComponent(window.location.hash);filters=[];regionFilter=false;withinFilter=false;$a.split("#").filter(function(_a){return _a}).forEach(function(ab){var bb=getFilter(ab);if(bb!==undefined){filters.push(bb)}});if(filters.length>0){displayEvents(filters)}})}function init(){$(window).bind("hashchange",function(cb){load()});$.ajax({url:"./geo.xml",async:false}).done(function(db){$geo=$(db);var eb=$('<div class="countries"><h4>Countries</h4></div>');$(".nav .controls").append(eb);$geo.find("r[id=1] > r").each(function(){var fb=$(this);var gb=fb.attr("id");var hb=fb.attr("n");var ib=$("<input type='checkbox' />");if(hb=="UK"){ib.attr("checked","")}ib.attr("data-region-id-"+gb,"");$geo.find("r[id="+gb+"] r").each(function(){$region=$(this);ib.attr("data-region-id-"+$region.attr("id"),"")});eb.append(ib).append($("<span />").text(hb)).append($("<br />"));ib.change(function(){load()})})});$("#letter-prefix").keypress(function(jb){if(jb.which==13){var kb=$("#letter-prefix").val();var kb=Array.from(new Set(kb.toLowerCase().replace(/[^a-z]/gi,"").split(""))).join("");window.location.hash="#matches-^["+kb+"]"}});$("#search").keypress(function(lb){if(lb.which==13){var mb=$("#search").val();window.location.hash="#matches-.*"+mb+".*"}})}function initAndLoad(){init();load()}
