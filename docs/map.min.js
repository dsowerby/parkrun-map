var mymap;var markerGroup;var $geo;var options;var athleteData=[];var filters=[];var position;var hamburger;var regionFilter;var withinFilter;var closestFilter;var events;$(document).ready(function(){initOptions();initMap();initBurger();centreMap();initAndLoad()});navigator.geolocation.getCurrentPosition(function(a){position=a;initAndLoad()},function(b){initAndLoad()});function initOptions(){options=JSON.parse(Cookies.get("options")||"{}")}function initBurger(){hamburger={navToggle:document.querySelector(".nav-toggle"),nav:document.querySelector(".nav"),doToggle:function(c){c.preventDefault();this.navToggle.classList.toggle("expanded");this.nav.classList.toggle("expanded")},show:function(){this.navToggle.classList.add("expanded");this.nav.classList.add("expanded")},hide:function(){this.navToggle.classList.remove("expanded");this.nav.classList.remove("expanded")}};hamburger.navToggle.addEventListener("click",function(d){hamburger.doToggle(d)})}function initMap(){mymap=L.map("mapid",{fullscreenControl:true,fullscreenControlOptions:{position:"topright"},zoomControl:false,maxBounds:new L.LatLngBounds(new L.LatLng(-90,-180),new L.LatLng(90,180)),minZoom:2});L.control.zoom({position:"topright"}).addTo(mymap);markerGroup=L.featureGroup().addTo(mymap);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(mymap);mymap.on("contextmenu",function(e){window.location.hash="#closest-5-"+e.latlng.lat+","+e.latlng.lng})}function centreMap(){if(position){mymap.fitBounds([[position.coords.latitude-.01,position.coords.longitude-.01],[position.coords.latitude+.01,position.coords.longitude+.01]])}else{mymap.fitBounds([[49.095026,-7.742293],[60.258081000000004,1.847338]])}}function displayEvents(f){if(f.length==0){return}var g=0;events=$geo.find("e");console.info("initial size: "+events.length);console.info("processing with "+f.length+" filters");for(var h=0;h<f.length;h++){var i=[];var j=f[h];events=j(events);console.info("after filter "+h+" there are "+events.length+" events")}if(f.length>0){if(!(regionFilter||withinFilter||closestFilter)){var k=$(".countries input:checked");if(k.length>0){var l="or-";for(var m=0;m<k.length;m++){l+="region-"+$(k[m]).attr("name")+"||"}l=l.substring(0,l.length-2);events=getFilter(l)(events)}}console.info("after all filters there are "+events.length+" events")}window.events=events;for(var n=0;n<events.length;n++){var o=$(events[n]);var p=parseFloat(o.attr("lo"));var q=parseFloat(o.attr("la"));var r=o.attr("m");if(!isNaN(p)&&!isNaN(q)){addMarker(q,p,r,"blue",o);g++}}if(g>0){mymap.fitBounds(markerGroup.getBounds());hamburger.hide();console.info(g+" events displayed")}else{hamburger.show();console.info("no events displayed")}}function addMarker(s,t,u,v,w){var x=L.icon({iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-"+v+".png",shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});var y=L.marker([s,t],{icon:x});var z;if(typeof w!=="undefined"){var A=w.attr("n");var B=w.attr("r");if(B!=""){var C=$geo.find("r[id="+B+"]").closest("r[u!='']").attr("u")}z='<strong><a target="_blank" href="'+C+"/"+A+'/">'+u+'</a></strong><br /><a target="_blank" href="'+C+"/"+A+'/course/">Course page</a><br /><a target="_blank" href="'+C+"/"+A+'/futureroster/">Future Roster</a><br /><a target="_blank" href="https://www.google.com/maps/dir/?api=1&destination='+s+","+t+'">Directions</a>'}else if(typeof u!=="undefined"){z=u}if(options.vegan){if(typeof z!=="undefined"){z+="<br />"}z+='<a target="_blank" href="https://www.happycow.net/searchmap?lat='+s+"&lng="+t+'&vegan=true">Local vegan food</a>'}if(options.nationaltrust){if(typeof z!=="undefined"){z+="<br />"}z+='<a target="_blank" href="https://www.nationaltrust.org.uk/search?lat='+s+"&lon="+t+'&type=place&view=map">National Trust venues</a>';z+="<br />";z+='<a target="_blank" href="https://www.nationaltrust.org.uk/search?lat='+s+"&lon="+t+'&type=place&view=map&PlaceFilter=houses-and-buildings">National Trust houses</a>'}if(options.premierinn){if(typeof z!=="undefined"){z+="<br />"}z+='<a target="_blank" href="https://www.premierinn.com/gb/en/search.html?&LOCATION='+s+","+t+'">Local Premier Inns</a>'}y.bindPopup(z);y.addTo(markerGroup)}function filterEvents(D,E){return function(F){var G=[];for(var H=0;H<F.length;H++){var I=$(F[H]);if(E(I)){G.push(I)}}return G}}function getFilter(J){if(J.startsWith("not-")){var K=J.substring(4);var M=getFilter(K);return function(ga){var ha=M(ga);return _.differenceWith(ga,ha,function(ia,ja){return $(ia).attr("id")==$(ja).attr("id")})}}else if(J.startsWith("and-")){var N=J.substring(4);var O=[];N.split("&&").filter(function(ka){return ka}).forEach(function(la){O.push(getFilter(la))});return function(ma){var na=ma;for(var oa=0;oa<O.length;oa++){na=O[oa](na)}return na}}else if(J.startsWith("or-")){var P=J.substring(3);var Q=[];P.split("||").filter(function(pa){return pa}).forEach(function(qa){Q.push(getFilter(qa))});return function(ra){orFilterResults=[];for(var sa=0;sa<Q.length;sa++){orFilterResults=_.union(orFilterResults,Q[sa](ra))}return orFilterResults}}else if(J.startsWith("startsWith-")){var R=J.substring(11);return filterEvents(events,function(ta){var ua=ta.attr("m");return ua.toLowerCase().startsWith(R.toLowerCase())})}else if(J.startsWith("contains-")){var S=J.substring(9);return filterEvents(events,function(va){var wa=va.attr("m");return wa.toLowerCase().indexOf(S.toLowerCase())>-1})}else if(J.startsWith("matches-")){var T=J.substring(8);var U=new RegExp(T,"i");return filterEvents(events,function(xa){var ya=xa.attr("m");return U.test(ya.toLowerCase())})}else if(J.startsWith("region-")){regionFilter=true;var V=J.substring(7);var W=$geo.find("r[n='"+V+"']");return filterEvents(events,function(za){var Aa=za.attr("r");return W.is('[id="'+Aa+'"]')||W.has('r[id="'+Aa+'"]').length>0})}else if(J.startsWith("athlete")){var X;if(J=="athlete"){X=options.athleteId}else{X=J.substring(8)}if(typeof athleteData[X]==="undefined"){$.ajax({url:"https://cors-anywhere.herokuapp.com/http://www.parkrun.org.uk/results/athleteeventresultshistory/?athleteNumber="+X+"&eventNumber=0",async:false}).done(function(Ba){athleteData[X]=$(Ba)})}return filterEvents(events,function(Ca){return athleteData[X].find("a[href$='/"+Ca.attr("n")+"/results']").length>0})}else if(J.startsWith("within-")){withinFilter=true;var Y=J.substring(7);var Z,aa,ba;if(isNaN(Y)){var ca=Y.indexOf("-");Z=Y.substring(0,ca);var da=Y.substring(ca+1).split(",");aa=da[0];ba=da[1]}else{Z=parseInt(J.substring(7));if(position===undefined){Z=0;aa=0;ba=0}else{aa=position.coords.latitude;ba=position.coords.longitude}}addMarker(aa,ba,"Within "+Z+"km","orange");return filterEvents(events,function(Da){var Ea=parseFloat(Da.attr("lo"));var Fa=parseFloat(Da.attr("la"));return getDistanceFromLatLonInKm(Fa,Ea,aa,ba)<Z})}else if(J=="compass"){return function(Ga){var Ha={};var Ia={};var Ja={};var Ka={};for(var La=0;La<Ga.length;La++){var Ma=$(this);var Ma=$(Ga[La]);var Na=parseFloat(Ma.attr("lo"));var Oa=parseFloat(Ma.attr("la"));if(isNaN(Ha.latitude)||Ha.latitude<Oa){Ha.longitude=Na;Ha.latitude=Oa;Ha.id=Ma.attr("id");Ha.event=Ma}if(isNaN(Ja.longitude)||Ja.longitude<Na){Ja.longitude=Na;Ja.latitude=Oa;Ja.id=Ma.attr("id");Ja.event=Ma}if(isNaN(Ia.latitude)||Ia.latitude>Oa){Ia.longitude=Na;Ia.latitude=Oa;Ia.id=Ma.attr("id");Ia.event=Ma}if(isNaN(Ka.longitude)||Ka.longitude>Na){Ka.longitude=Na;Ka.latitude=Oa;Ka.id=Ma.attr("id");Ka.event=Ma}}var Ga=[Ha.event,Ja.event,Ia.event,Ka.event];console.info(Ga);return _.uniq(Ga)}}else if(J.startsWith("closest")){closestFilter=true;var ea=J.substring(8);if(isNaN(ea)){var ca=ea.indexOf("-");var fa=ea.substring(ca+1).split(",");closestLatitude=fa[0];closestLongitude=fa[1];delete fa;ea=ea.substring(0,ca)}else{if(position===undefined){ea=0;closestLatitude=0;closestLongitude=0}else{if(position===undefined){ea=0;closestLatitude=0;closestLongitude=0}else{ea=parseInt(J.substring(8));closestLatitude=position.coords.latitude;closestLongitude=position.coords.longitude}}}return function(Pa){var Qa=[];for(var Ra=0;Ra<Pa.length;Ra++){$event=$(Pa[Ra]);var Sa=parseFloat($event.attr("lo"));var Ta=parseFloat($event.attr("la"));var Ua=getDistanceFromLatLonInKm(Ta,Sa,closestLatitude,closestLongitude);Qa.push({event:$event,distance:Ua})}var Va=Qa.sort(function(Ya,Za){return Ya.distance-Za.distance});console.info(Va);var Wa=[];if(Qa.length<ea){ea=Qa.length}addMarker(closestLatitude,closestLongitude,"Closest "+ea+" event ","green");for(var Xa=0;Xa<ea;Xa++){Wa.push(Qa[Xa].event)}return Wa}}else if(J==="none"){return filterEvents(events,function($a){return[]})}else if(J==="all"){return function(_a){return _a}}}function getDistanceFromLatLonInKm(ab,bb,cb,db){var eb=6371;var fb=deg2rad(cb-ab);var gb=deg2rad(db-bb);var hb=Math.sin(fb/2)*Math.sin(fb/2)+Math.cos(deg2rad(ab))*Math.cos(deg2rad(cb))*Math.sin(gb/2)*Math.sin(gb/2);var ib=2*Math.atan2(Math.sqrt(hb),Math.sqrt(1-hb));var jb=eb*ib;return jb}function deg2rad(kb){return kb*(Math.PI/180)}function load(){$(document).ready(function(){markerGroup.clearLayers();var lb=decodeURIComponent(window.location.hash);filters=[];regionFilter=false;withinFilter=false;closestFilter=false;lb.split("#").filter(function(mb){return mb}).forEach(function(nb){var ob=getFilter(nb);if(ob!==undefined){filters.push(ob)}});displayEvents(filters)})}function init(){$(window).bind("hashchange",function(pb){load()});$.ajax({url:"./geo.xml",async:false}).done(function(qb){$geo=$(qb);var rb=$('<div class="countries"><h4>Countries</h4></div>');$(".nav .controls").append(rb);$geo.find("r[id=1] > r").each(function(){var sb=$(this);var tb=sb.attr("id");var ub=sb.attr("n");var vb=$("<input type='checkbox' />");vb.attr("name",ub);if(ub=="UK"){vb.attr("checked","")}vb.attr("data-region-id-"+tb,"");$geo.find("r[id="+tb+"] r").each(function(){$region=$(this);vb.attr("data-region-id-"+$region.attr("id"),"")});rb.append(vb).append($("<span />").text(ub)).append($("<br />"));vb.change(function(){load()})})});$("#letter-prefix").keypress(function(wb){if(wb.which==13){var xb=$("#letter-prefix").val();var xb=Array.from(new Set(xb.toLowerCase().replace(/[^a-z]/gi,"").split(""))).join("");window.location.hash="#matches-^["+xb+"]"}});$("#search").keypress(function(yb){if(yb.which==13){var zb=$("#search").val();window.location.hash="#matches-.*"+zb+".*"}})}function initAndLoad(){init();load()}
