var mymap;var markerGroup;var $geo;var options;var athleteData=[];var filters=[];var position;var hamburger;var regionFilter;var withinFilter;navigator.geolocation.getCurrentPosition(function(a){position=a;initAndLoad()},function(b){initAndLoad()});$(document).ready(function(){initAjaxPrefilter();initOptions();initMap();initBurger();centreMap();initAndLoad()});function initAjaxPrefilter(){jQuery.ajaxPrefilter(function(c){if(c.crossDomain&&jQuery.support.cors){c.url="https://cors-anywhere.herokuapp.com/"+c.url}})}function initOptions(){options=JSON.parse(Cookies.get("options")||"{}")}function initBurger(){hamburger={navToggle:document.querySelector(".nav-toggle"),nav:document.querySelector(".nav"),doToggle:function(d){d.preventDefault();this.navToggle.classList.toggle("expanded");this.nav.classList.toggle("expanded")},show:function(){this.navToggle.classList.add("expanded");this.nav.classList.add("expanded")},hide:function(){this.navToggle.classList.remove("expanded");this.nav.classList.remove("expanded")}};hamburger.navToggle.addEventListener("click",function(e){hamburger.doToggle(e)})}function initMap(){mymap=L.map("mapid",{fullscreenControl:true,zoomControl:false,maxBounds:new L.LatLngBounds(new L.LatLng(-90,-180),new L.LatLng(90,180)),minZoom:2});L.control.zoom({position:"topright"}).addTo(mymap);markerGroup=L.featureGroup().addTo(mymap);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(mymap);mymap.on("contextmenu",function(f){window.location.hash="#closest-5-"+f.latlng.lat+","+f.latlng.lng});L.Control.Watermark=L.Control.extend({onAdd:function(g){var h=L.DomUtil.create("img");h.src="https://leafletjs.com/docs/images/logo.png";h.style.width="100px";return h},onRemove:function(i){}});L.control.watermark=function(j){return new L.Control.Watermark(j)};L.control.watermark({position:"topleft"}).addTo(mymap)}function centreMap(){if(position){mymap.fitBounds([[position.coords.latitude-.01,position.coords.longitude-.01],[position.coords.latitude+.01,position.coords.longitude+.01]])}else{mymap.fitBounds([[49.095026,-7.742293],[60.258081000000004,1.847338]])}}function displayEvents(k){var l=0;$geo.find("e").each(function(){var m=$(this);var n=m.attr("m");var o=m.attr("r");if(o!=""){var p=$geo.find("r[id="+o+"]").closest("r[u!='']").attr("u")}var q=$("[data-region-id-"+o+"]");var r=q.prop("checked");var s=false;if(r||regionFilter||withinFilter){s=true;for(var t=0;t<k.length;t++){if(s){var u=k[t](m);s=s&&u}}}if(s){var v=parseFloat(m.attr("lo"));var w=parseFloat(m.attr("la"));console.info(m.attr("n"));if(!isNaN(v)&&!isNaN(w)){addMarker(w,v,n,"blue",m);l++}}});if(l>0){mymap.fitBounds(markerGroup.getBounds());hamburger.hide();console.info(l+" events displayed")}else{hamburger.show();console.info("no events displayed")}}function addMarker(x,y,z,A,B){var C=L.icon({iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-"+A+".png",shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});var D=L.marker([x,y],{icon:C});var E;if(typeof B!=="undefined"){var F=B.attr("n");var G=B.attr("r");if(G!=""){var H=$geo.find("r[id="+G+"]").closest("r[u!='']").attr("u")}E='<strong><a target="_blank" href="'+H+"/"+F+'/">'+z+'</a></strong><br /><a target="_blank" href="'+H+"/"+F+'/course/">Course page</a><br /><a target="_blank" href="'+H+"/"+F+'/futureroster/">Future Roster</a><br /><a target="_blank" href="https://www.google.com/maps/dir/?api=1&destination='+x+","+y+'">Directions</a>'}else if(typeof z!=="undefined"){E=z}if(options.vegan){if(typeof E!=="undefined"){E+="<br />"}E+='<a target="_blank" href="https://www.happycow.net/searchmap?lat='+x+"&lng="+y+'&vegan=true">Local vegan food</a>'}if(options.nationaltrust){if(typeof E!=="undefined"){E+="<br />"}E+='<a target="_blank" href="https://www.nationaltrust.org.uk/search?lat='+x+"&lon="+y+'&type=place&view=map">National Trust venues</a>'}if(options.premierinn){if(typeof E!=="undefined"){E+="<br />"}E+='<a target="_blank" href="https://www.premierinn.com/gb/en/search.html?&LOCATION='+x+","+y+'">Local Premier Inns</a>'}D.bindPopup(E);D.addTo(markerGroup)}function getFilter(I){if(I.startsWith("not-")){var J=I.substring(4);var K=getFilter(J);return function(ia){return!K(ia)}}else if(I.startsWith("and-")){var M=I.substring(4);var N=[];M.split("&&").filter(function(ja){return ja}).forEach(function(ka){N.push(getFilter(ka))});return function(la){for(var ma=0;ma<N.length;ma++){if(!N[ma](la)){return false}}return true}}else if(I.startsWith("or-")){var O=I.substring(3);var P=[];O.split("||").filter(function(na){return na}).forEach(function(oa){P.push(getFilter(oa))});return function(pa){for(var qa=0;qa<P.length;qa++){if(P[qa](pa)){return true}}return false}}else if(I.startsWith("startsWith-")){var Q=I.substring(11);return function(ra){var sa=ra.attr("m");return sa.toLowerCase().startsWith(Q.toLowerCase())}}else if(I.startsWith("contains-")){var R=I.substring(9);return function(ta){var ua=ta.attr("m");return ua.toLowerCase().indexOf(R.toLowerCase())>-1}}else if(I.startsWith("matches-")){var S=I.substring(8);var T=new RegExp(S,"i");return function(va){var wa=va.attr("m");return T.test(wa.toLowerCase())}}else if(I.startsWith("region-")){regionFilter=true;var U=I.substring(7);var V=$geo.find("r[n='"+U+"']");window.regionElement=V;return function(xa){var ya=xa.attr("r");return V.is('[id="'+ya+'"]')||V.has('r[id="'+ya+'"]').length>0}}else if(I.startsWith("athlete")){var W;if(I=="athlete"){W=options.athleteId}else{W=I.substring(8)}if(typeof athleteData[W]==="undefined"){$.ajax({url:"https://www.parkrun.org.uk:443/results/athleteeventresultshistory/?athleteNumber="+W+"&eventNumber=0",async:false}).done(function(za){athleteData[W]=$(za)})}return function(Aa){return athleteData[W].find("a[href$='/"+Aa.attr("n")+"/results']").length>0}}else if(I.startsWith("within-")){withinFilter=true;var X=I.substring(7);var Y,Z,_;if(isNaN(X)){var aa=X.indexOf("-");Y=X.substring(0,aa);var ba=X.substring(aa+1).split(",");Z=ba[0];_=ba[1]}else{Y=parseInt(I.substring(7));if(position===undefined){Y=0;Z=0;_=0}else{Z=position.coords.latitude;_=position.coords.longitude}}addMarker(Z,_,"Within "+Y+"km","orange");return function(Ba){var Ca=parseFloat(Ba.attr("lo"));var Da=parseFloat(Ba.attr("la"));return getDistanceFromLatLonInKm(Da,Ca,Z,_)<Y}}else if(I.startsWith("closest")){withinFilter=true;var ca=I.substring(8);if(isNaN(ca)){var aa=ca.indexOf("-");var da=ca.substring(aa+1).split(",");closestLatitude=da[0];closestLongitude=da[1];delete da;ca=ca.substring(0,aa)}else{if(position===undefined){ca=0;closestLatitude=0;closestLongitude=0}else{if(position===undefined){ca=0;closestLatitude=0;closestLongitude=0}else{ca=parseInt(I.substring(8));closestLatitude=position.coords.latitude;closestLongitude=position.coords.longitude}}}var ea=[];var fa=[];var ga=[];console.info("Looking for the closest "+ca+" events to "+closestLatitude+","+closestLongitude);$geo.find('e[lo!=""][la!=""]').each(function(){var Ea=$(this);var Fa=parseFloat(Ea.attr("lo"));var Ga=parseFloat(Ea.attr("la"));var Ha=getDistanceFromLatLonInKm(Ga,Fa,closestLatitude,closestLongitude);fa.push({id:Ea.attr("id"),distance:Ha})});ga=fa.sort(function(Ia,Ja){return Ia.distance-Ja.distance}).slice(0,ca);delete fa;for(var ha=0;ha<ga.length;ha++){ea.push(ga[ha].id)}delete ga;addMarker(closestLatitude,closestLongitude,"Closest "+ca+" event ","green");return function(Ka){return ea.indexOf(Ka.attr("id"))>-1}}else if(I==="none"){return function(){return false}}else if(I==="all"){return function(){return true}}}function getDistanceFromLatLonInKm(La,Ma,Na,Oa){var Pa=6371;var Qa=deg2rad(Na-La);var Ra=deg2rad(Oa-Ma);var Sa=Math.sin(Qa/2)*Math.sin(Qa/2)+Math.cos(deg2rad(La))*Math.cos(deg2rad(Na))*Math.sin(Ra/2)*Math.sin(Ra/2);var Ta=2*Math.atan2(Math.sqrt(Sa),Math.sqrt(1-Sa));var Ua=Pa*Ta;return Ua}function deg2rad(Va){return Va*(Math.PI/180)}function load(){$(document).ready(function(){markerGroup.clearLayers();var Wa=decodeURIComponent(window.location.hash);filters=[];regionFilter=false;withinFilter=false;Wa.split("#").filter(function(Xa){return Xa}).forEach(function(Ya){var Za=getFilter(Ya);if(Za!==undefined){filters.push(Za)}});if(filters.length>0){displayEvents(filters)}})}function init(){$(window).bind("hashchange",function($a){load()});$.ajax({url:"https://www.parkrun.org.uk/wp-content/themes/parkrun/xml/geo.xml",async:false}).done(function(_a){$geo=$(_a);var ab=$('<div class="countries"><h4>Countries</h4></div>');$(".nav .controls").append(ab);$geo.find("r[id=1] > r").each(function(){var bb=$(this);var cb=bb.attr("id");var db=bb.attr("n");var eb=$("<input type='checkbox' />");if(db=="UK"){eb.attr("checked","")}eb.attr("data-region-id-"+cb,"");$geo.find("r[id="+cb+"] r").each(function(){$region=$(this);eb.attr("data-region-id-"+$region.attr("id"),"")});ab.append(eb).append($("<span />").text(db)).append($("<br />"));eb.change(function(){load()})})});$("#letter-prefix").keypress(function(fb){if(fb.which==13){var gb=$("#letter-prefix").val();var gb=Array.from(new Set(gb.toLowerCase().replace(/[^a-z]/gi,"").split(""))).join("");window.location.hash="#matches-^["+gb+"]"}});$("#search").keypress(function(hb){if(hb.which==13){var ib=$("#search").val();window.location.hash="#matches-.*"+ib+".*"}})}function initAndLoad(){init();load()}
