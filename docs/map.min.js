var mymap;var markerGroup;var $geo;var options;var athleteData=[];var filters=[];var position;var hamburger;var regionFilter;var withinFilter;navigator.geolocation.getCurrentPosition(function(a){position=a;initAndLoad()},function(b){initAndLoad()});$(document).ready(function(){initAjaxPrefilter();initOptions();initMap();initBurger();centreMap();initAndLoad()});function initAjaxPrefilter(){jQuery.ajaxPrefilter(function(c){if(c.crossDomain&&jQuery.support.cors){c.url="https://cors-anywhere.herokuapp.com/"+c.url}})}function initOptions(){options=JSON.parse(Cookies.get("options")||"{}")}function initBurger(){hamburger={navToggle:document.querySelector(".nav-toggle"),nav:document.querySelector(".nav"),doToggle:function(d){d.preventDefault();this.navToggle.classList.toggle("expanded");this.nav.classList.toggle("expanded")},show:function(){this.navToggle.classList.add("expanded");this.nav.classList.add("expanded")},hide:function(){this.navToggle.classList.remove("expanded");this.nav.classList.remove("expanded")}};hamburger.navToggle.addEventListener("click",function(e){hamburger.doToggle(e)})}function initMap(){mymap=L.map("mapid",{zoomControl:false,maxBounds:new L.LatLngBounds(new L.LatLng(-90,-180),new L.LatLng(90,180)),minZoom:2});L.control.zoom({position:"topright"}).addTo(mymap);markerGroup=L.featureGroup().addTo(mymap);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(mymap);mymap.on("contextmenu",function(f){window.location.hash="#closest-5-"+f.latlng.lat+","+f.latlng.lng})}function centreMap(){if(position){mymap.fitBounds([[position.coords.latitude-.01,position.coords.longitude-.01],[position.coords.latitude+.01,position.coords.longitude+.01]])}else{mymap.fitBounds([[49.095026,-7.742293],[60.258081000000004,1.847338]])}}function displayEvents(g){var h=0;$geo.find("e").each(function(){var i=$(this);var j=i.attr("m");var k=i.attr("r");if(k!=""){var l=$geo.find("r[id="+k+"]").closest("r[u!='']").attr("u")}var m=$("[data-region-id-"+k+"]");var n=m.prop("checked");var o=false;if(n||regionFilter||withinFilter){o=true;for(var p=0;p<g.length;p++){if(o){var q=g[p](i);o=o&&q}}}if(o){var r=parseFloat(i.attr("lo"));var s=parseFloat(i.attr("la"));if(!isNaN(r)&&!isNaN(s)){addMarker(s,r,j,"blue",i);h++}}});if(h>0){mymap.fitBounds(markerGroup.getBounds());hamburger.hide();console.info(h+" events displayed")}else{hamburger.show();console.info("no events displayed")}}function addMarker(t,u,v,w,x){var y=L.icon({iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-"+w+".png",shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});var z=L.marker([t,u],{icon:y});var A;if(typeof x!=="undefined"){var B=x.attr("n");var C=x.attr("r");if(C!=""){var D=$geo.find("r[id="+C+"]").closest("r[u!='']").attr("u")}A='<strong><a target="_blank" href="'+D+"/"+B+'/">'+v+'</a></strong><br /><a target="_blank" href="'+D+"/"+B+'/course/">Course page</a><br /><a target="_blank" href="'+D+"/"+B+'/futureroster/">Future Roster</a><br /><a target="_blank" href="https://www.google.com/maps/dir/?api=1&destination='+t+","+u+'">Directions</a>'}else if(typeof v!=="undefined"){A=v}if(options.vegan){if(typeof A!=="undefined"){A+="<br />"}A+='<a target="_blank" href="https://www.happycow.net/searchmap?lat='+t+"&lng="+u+'&vegan=true">Local vegan food</a>'}z.bindPopup(A);z.addTo(markerGroup)}function getFilter(E){if(E.startsWith("not-")){var F=E.substring(4);var G=getFilter(F);return function(ea){return!G(ea)}}else if(E.startsWith("and-")){var H=E.substring(4);var I=[];H.split("&&").filter(function(fa){return fa}).forEach(function(ga){I.push(getFilter(ga))});return function(ha){for(var ia=0;ia<I.length;ia++){if(!I[ia](ha)){return false}}return true}}else if(E.startsWith("or-")){var J=E.substring(3);var K=[];J.split("||").filter(function(ja){return ja}).forEach(function(ka){K.push(getFilter(ka))});return function(la){for(var ma=0;ma<K.length;ma++){if(K[ma](la)){return true}}return false}}else if(E.startsWith("startsWith-")){var M=E.substring(11);return function(na){var oa=na.attr("m");return oa.toLowerCase().startsWith(M.toLowerCase())}}else if(E.startsWith("contains-")){var N=E.substring(9);return function(pa){var qa=pa.attr("m");return qa.toLowerCase().indexOf(N.toLowerCase())>-1}}else if(E.startsWith("matches-")){var O=E.substring(8);var P=new RegExp(O,"i");return function(ra){var sa=ra.attr("m");return P.test(sa.toLowerCase())}}else if(E.startsWith("region-")){regionFilter=true;var Q=E.substring(7);var R=$geo.find("r[n='"+Q+"']");window.regionElement=R;return function(ta){var ua=ta.attr("r");return R.is('[id="'+ua+'"]')||R.has('r[id="'+ua+'"]').length>0}}else if(E.startsWith("athlete")){var S;if(E=="athlete"){S=options.athleteId}else{S=E.substring(8)}if(typeof athleteData[S]==="undefined"){$.ajax({url:"https://www.parkrun.org.uk:443/results/athleteeventresultshistory/?athleteNumber="+S+"&eventNumber=0",async:false}).done(function(va){athleteData[S]=$(va)})}return function(wa){return athleteData[S].find("a[href$='/"+wa.attr("n")+"/results']").length>0}}else if(E.startsWith("within-")){withinFilter=true;var T=E.substring(7);var U,V,W;if(isNaN(T)){var X=T.indexOf("-");U=T.substring(0,X);var Y=T.substring(X+1).split(",");V=Y[0];W=Y[1]}else{U=parseInt(E.substring(7));if(position===undefined){U=0;V=0;W=0}else{V=position.coords.latitude;W=position.coords.longitude}}addMarker(V,W,"Within "+U+"km","orange");return function(xa){var ya=parseFloat(xa.attr("lo"));var za=parseFloat(xa.attr("la"));return getDistanceFromLatLonInKm(za,ya,V,W)<U}}else if(E.startsWith("closest")){withinFilter=true;var Z=E.substring(8);if(isNaN(Z)){var X=Z.indexOf("-");var _=Z.substring(X+1).split(",");closestLatitude=_[0];closestLongitude=_[1];delete _;Z=Z.substring(0,X)}else{if(position===undefined){Z=0;closestLatitude=0;closestLongitude=0}else{if(position===undefined){Z=0;closestLatitude=0;closestLongitude=0}else{Z=parseInt(E.substring(8));closestLatitude=position.coords.latitude;closestLongitude=position.coords.longitude}}}var aa=[];var ba=[];var ca=[];console.info("Looking for the closest "+Z+" events to "+closestLatitude+","+closestLongitude);$geo.find('e[lo!=""][la!=""]').each(function(){var Aa=$(this);var Ba=parseFloat(Aa.attr("lo"));var Ca=parseFloat(Aa.attr("la"));var Da=getDistanceFromLatLonInKm(Ca,Ba,closestLatitude,closestLongitude);ba.push({id:Aa.attr("id"),distance:Da})});ca=ba.sort(function(Ea,Fa){return Ea.distance-Fa.distance}).slice(0,Z);delete ba;for(var da=0;da<ca.length;da++){aa.push(ca[da].id)}delete ca;addMarker(closestLatitude,closestLongitude,"Closest "+Z+" event ","green");return function(Ga){return aa.indexOf(Ga.attr("id"))>-1}}else if(E==="none"){return function(){return false}}else if(E==="all"){return function(){return true}}}function getDistanceFromLatLonInKm(Ha,Ia,Ja,Ka){var La=6371;var Ma=deg2rad(Ja-Ha);var Na=deg2rad(Ka-Ia);var Oa=Math.sin(Ma/2)*Math.sin(Ma/2)+Math.cos(deg2rad(Ha))*Math.cos(deg2rad(Ja))*Math.sin(Na/2)*Math.sin(Na/2);var Pa=2*Math.atan2(Math.sqrt(Oa),Math.sqrt(1-Oa));var Qa=La*Pa;return Qa}function deg2rad(Ra){return Ra*(Math.PI/180)}function load(){$(document).ready(function(){markerGroup.clearLayers();var Sa=decodeURIComponent(window.location.hash);filters=[];regionFilter=false;withinFilter=false;Sa.split("#").filter(function(Ta){return Ta}).forEach(function(Ua){var Va=getFilter(Ua);if(Va!==undefined){filters.push(Va)}});if(filters.length>0){displayEvents(filters)}})}function init(){$(window).bind("hashchange",function(Wa){load()});$.ajax({url:"https://www.parkrun.org.uk/wp-content/themes/parkrun/xml/geo.xml",async:false}).done(function(Xa){$geo=$(Xa);var Ya=$('<div class="countries"><h4>Countries</h4></div>');$(".nav .controls").append(Ya);$geo.find("r[id=1] > r").each(function(){var Za=$(this);var $a=Za.attr("id");var _a=Za.attr("n");var ab=$("<input type='checkbox' />");if(_a=="UK"){ab.attr("checked","")}ab.attr("data-region-id-"+$a,"");$geo.find("r[id="+$a+"] r").each(function(){$region=$(this);ab.attr("data-region-id-"+$region.attr("id"),"")});Ya.append(ab).append($("<span />").text(_a)).append($("<br />"));ab.change(function(){load()})})});$("#letter-prefix").keypress(function(bb){if(bb.which==13){var cb=$("#letter-prefix").val();var cb=Array.from(new Set(cb.toLowerCase().replace(/[^a-z]/gi,"").split(""))).join("");window.location.hash="#matches-^["+cb+"]"}});$("#search").keypress(function(db){if(db.which==13){var eb=$("#search").val();window.location.hash="#matches-.*"+eb+".*"}})}function initAndLoad(){init();load()}
