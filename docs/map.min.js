var mymap;var markerGroup;var $geo;var options;var athleteData=[];var filters=[];var position;var hamburger;var regionFilter;$(document).ready(function(){initAjaxPrefilter();initOptions();initMap();initBurger();centreMap();navigator.geolocation.getCurrentPosition(function(a){position=a;initAndLoad()},function(b){initAndLoad()})});function initAjaxPrefilter(){jQuery.ajaxPrefilter(function(c){if(c.crossDomain&&jQuery.support.cors){c.url="https://cors-anywhere.herokuapp.com/"+c.url}})}function initOptions(){options=JSON.parse(Cookies.get("options")||"{}")}function initBurger(){hamburger={navToggle:document.querySelector(".nav-toggle"),nav:document.querySelector(".nav"),doToggle:function(d){d.preventDefault();this.navToggle.classList.toggle("expanded");this.nav.classList.toggle("expanded")},show:function(){this.navToggle.classList.add("expanded");this.nav.classList.add("expanded")},hide:function(){this.navToggle.classList.remove("expanded");this.nav.classList.remove("expanded")}};hamburger.navToggle.addEventListener("click",function(e){hamburger.doToggle(e)})}function initMap(){mymap=L.map("mapid",{zoomControl:false,maxBounds:new L.LatLngBounds(new L.LatLng(-90,-180),new L.LatLng(90,180)),minZoom:2});L.control.zoom({position:"topright"}).addTo(mymap);markerGroup=L.layerGroup().addTo(mymap);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(mymap)}function centreMap(){if(position){mymap.fitBounds([[position.coords.latitude-.01,position.coords.longitude-.01],[position.coords.latitude+.01,position.coords.longitude+.01]])}else{mymap.fitBounds([[49.095026,-7.742293],[60.258081000000004,1.847338]])}}function displayEvents(f){var g=longitudeMax=latitudeMin=latitudeMax=undefined;var h=0;$geo.find("e").each(function(){var i=$(this);var j=i.attr("m");var k=i.attr("r");if(k!=""){var l=$geo.find("r[id="+k+"]").closest("r[u!='']").attr("u")}var m=$("[data-region-id-"+k+"]");var n=m.prop("checked");var o=false;if(n||regionFilter){o=true;for(var p=0;p<f.length;p++){if(o){var q=f[p](i);o=o&&q}}}if(o){var r=i.attr("n");var s=parseFloat(i.attr("lo"));var t=parseFloat(i.attr("la"));if(!isNaN(s)&&!isNaN(t)){if(s<g||typeof g=="undefined"){g=s}if(t<latitudeMin||typeof latitudeMin=="undefined"){latitudeMin=t}if(s>longitudeMax||typeof longitudeMax=="undefined"){longitudeMax=s}if(t>latitudeMax||typeof latitudeMax=="undefined"){latitudeMax=t}var u=L.marker([t,s]);if(typeof l!==undefined){var v='<strong><a target="_blank" href="'+l+"/"+r+'/">'+j+'</a></strong><br /><a target="_blank" href="'+l+"/"+r+'/course/">Course page</a><br /><a target="_blank" href="https://www.google.com/maps/dir/?api=1&destination='+t+","+s+'">Directions</a>';if(options.vegan){v+='<br /><a target="_blank" href="https://www.happycow.net/searchmap?lat='+t+"&lng="+s+'&vegan=true">Local vegan food</a>'}u.bindPopup(v)}else{u.bindPopup(j)}u.addTo(markerGroup);h++}}});if(h>0){latitudeMin=latitudeMin-.1;g=g-.1;latitudeMax=latitudeMax+.1;longitudeMax=longitudeMax+.1;mymap.fitBounds([[latitudeMin,g],[latitudeMax,longitudeMax]]);hamburger.hide()}else{hamburger.show();console.info("no events displayed")}}$(window).bind("hashchange",function(w){load()});function getFilter(x){if(x.startsWith("not-")){var y=x.substring(4);var z=getFilter(y);return function(S){return!z(S)}}else if(x.startsWith("or-")){var A=x.substring(3);var B=[];A.split("|").filter(function(T){return T}).forEach(function(U){B.push(getFilter(U))});return function(V){for(var W=0;W<B.length;W++){if(B[W](V)){return true}}return false}}else if(x.startsWith("startsWith-")){var C=x.substring(11);return function(X){var Y=X.attr("m");return Y.toLowerCase().startsWith(C.toLowerCase())}}else if(x.startsWith("contains-")){var D=x.substring(9);return function(Z){var _=Z.attr("m");return _.toLowerCase().indexOf(D.toLowerCase())>-1}}else if(x.startsWith("matches-")){var E=x.substring(8);var F=new RegExp(E,"i");return function(aa){var ba=aa.attr("m");return F.test(ba.toLowerCase())}}else if(x.startsWith("region-")){regionFilter=true;var G=x.substring(7);var H=$geo.find("r[n='"+G+"']");window.regionElement=H;return function(ca){var da=ca.attr("r");return H.is('[id="'+da+'"]')||H.has('r[id="'+da+'"]').length>0}}else if(x.startsWith("athlete-")){var I=x.substring(8);if(typeof athleteData[I]==="undefined"){$.ajax({url:"https://www.parkrun.org.uk:443/results/athleteeventresultshistory/?athleteNumber="+I+"&eventNumber=0",async:false}).done(function(ea){athleteData[I]=$(ea)})}return function(fa){return athleteData[I].find("a[href$='/"+fa.attr("n")+"/results']").length>0}}else if(x.startsWith("within-")){var J=x.substring(7);var K,M,N;if(isNaN(J)){var O=J.indexOf("-");K=J.substring(0,O);var P=J.substring(O+1).split(",");M=P[0];N=P[1]}else{K=parseInt(x.substring(7));M=position.coords.latitude;N=position.coords.longitude}var Q=L.icon({iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-orange.png",shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});var R=L.marker([M,N],{icon:Q});R.addTo(markerGroup);return function(ga){var ha=parseFloat(ga.attr("lo"));var ia=parseFloat(ga.attr("la"));return getDistanceFromLatLonInKm(ia,ha,M,N)<K}}else if(x==="none"){return function(){return false}}else if(x==="all"){return function(){return true}}}function getDistanceFromLatLonInKm(ja,ka,la,ma){var na=6371;var oa=deg2rad(la-ja);var pa=deg2rad(ma-ka);var qa=Math.sin(oa/2)*Math.sin(oa/2)+Math.cos(deg2rad(ja))*Math.cos(deg2rad(la))*Math.sin(pa/2)*Math.sin(pa/2);var ra=2*Math.atan2(Math.sqrt(qa),Math.sqrt(1-qa));var sa=na*ra;return sa}function deg2rad(ta){return ta*(Math.PI/180)}function load(){$(document).ready(function(){markerGroup.clearLayers();var ua=decodeURIComponent(window.location.hash);filters=[];regionFilter=false;ua.split("#").filter(function(va){return va}).forEach(function(wa){var xa=getFilter(wa);if(xa!==undefined){filters.push(xa)}});if(filters.length>0){displayEvents(filters)}})}function init(){$.ajax({url:"geo.xml",async:false}).done(function(ya){$geo=$(ya);var za=$('<div class="countries"><h4>Countries</h4></div>');$(".nav .controls").append(za);$geo.find("r[id=1] > r").each(function(){var Aa=$(this);var Ba=Aa.attr("id");var Ca=Aa.attr("n");var Da=$("<input type='checkbox' />");if(Ca=="UK"){Da.attr("checked","")}Da.attr("data-region-id-"+Ba,"");$geo.find("r[id="+Ba+"] r").each(function(){$region=$(this);Da.attr("data-region-id-"+$region.attr("id"),"")});za.append(Da).append($("<span />").text(Ca)).append($("<br />"));Da.change(function(){load()})})});$("#letter-prefix").keypress(function(Ea){if(Ea.which==13){var Fa=$("#letter-prefix").val();var Fa=Array.from(new Set(Fa.toLowerCase().replace(/[^a-z]/gi,"").split(""))).join("");window.location.hash="#matches-^["+Fa+"]"}});$("#search").keypress(function(Ga){if(Ga.which==13){var Ha=$("#search").val();window.location.hash="#matches-.*"+Ha+".*"}})}function initAndLoad(){init();load()}
