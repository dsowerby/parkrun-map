var mymap;var markerGroup;var $geo;var options;var athleteData=[];var filters=[];var position;var hamburger;var regionFilter;var withinFilter;navigator.geolocation.getCurrentPosition(function(a){position=a;initAndLoad()},function(b){initAndLoad()});$(document).ready(function(){initAjaxPrefilter();initOptions();initMap();initBurger();centreMap();initAndLoad()});function initAjaxPrefilter(){jQuery.ajaxPrefilter(function(c){if(c.crossDomain&&jQuery.support.cors){c.url="https://cors-anywhere.herokuapp.com/"+c.url}})}function initOptions(){options=JSON.parse(Cookies.get("options")||"{}")}function initBurger(){hamburger={navToggle:document.querySelector(".nav-toggle"),nav:document.querySelector(".nav"),doToggle:function(d){d.preventDefault();this.navToggle.classList.toggle("expanded");this.nav.classList.toggle("expanded")},show:function(){this.navToggle.classList.add("expanded");this.nav.classList.add("expanded")},hide:function(){this.navToggle.classList.remove("expanded");this.nav.classList.remove("expanded")}};hamburger.navToggle.addEventListener("click",function(e){hamburger.doToggle(e)})}function initMap(){mymap=L.map("mapid",{zoomControl:false,maxBounds:new L.LatLngBounds(new L.LatLng(-90,-180),new L.LatLng(90,180)),minZoom:2});L.control.zoom({position:"topright"}).addTo(mymap);markerGroup=L.featureGroup().addTo(mymap);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(mymap)}function centreMap(){if(position){mymap.fitBounds([[position.coords.latitude-.01,position.coords.longitude-.01],[position.coords.latitude+.01,position.coords.longitude+.01]])}else{mymap.fitBounds([[49.095026,-7.742293],[60.258081000000004,1.847338]])}}function displayEvents(f){var g=0;$geo.find("e").each(function(){var h=$(this);var i=h.attr("m");var j=h.attr("r");if(j!=""){var k=$geo.find("r[id="+j+"]").closest("r[u!='']").attr("u")}var l=$("[data-region-id-"+j+"]");var m=l.prop("checked");var n=false;if(m||regionFilter||withinFilter){n=true;for(var o=0;o<f.length;o++){if(n){var p=f[o](h);n=n&&p}}}if(n){var q=h.attr("n");var r=parseFloat(h.attr("lo"));var s=parseFloat(h.attr("la"));if(!isNaN(r)&&!isNaN(s)){var t=L.marker([s,r]);if(typeof k!==undefined){var u='<strong><a target="_blank" href="'+k+"/"+q+'/">'+i+'</a></strong><br /><a target="_blank" href="'+k+"/"+q+'/course/">Course page</a><br /><a target="_blank" href="https://www.google.com/maps/dir/?api=1&destination='+s+","+r+'">Directions</a>';if(options.vegan){u+='<br /><a target="_blank" href="https://www.happycow.net/searchmap?lat='+s+"&lng="+r+'&vegan=true">Local vegan food</a>'}t.bindPopup(u)}else{t.bindPopup(i)}t.addTo(markerGroup);g++}}});if(g>0){mymap.fitBounds(markerGroup.getBounds());hamburger.hide()}else{hamburger.show();console.info("no events displayed")}}function getFilter(v){if(v.startsWith("not-")){var w=v.substring(4);var x=getFilter(w);return function(Y){return!x(Y)}}else if(v.startsWith("and-")){var y=v.substring(4);var z=[];y.split("&&").filter(function(Z){return Z}).forEach(function(_){z.push(getFilter(_))});return function(aa){for(var ba=0;ba<z.length;ba++){if(!z[ba](aa)){return false}}return true}}else if(v.startsWith("or-")){var A=v.substring(3);var B=[];A.split("||").filter(function(ca){return ca}).forEach(function(da){B.push(getFilter(da))});return function(ea){for(var fa=0;fa<B.length;fa++){if(B[fa](ea)){return true}}return false}}else if(v.startsWith("startsWith-")){var C=v.substring(11);return function(ga){var ha=ga.attr("m");return ha.toLowerCase().startsWith(C.toLowerCase())}}else if(v.startsWith("contains-")){var D=v.substring(9);return function(ia){var ja=ia.attr("m");return ja.toLowerCase().indexOf(D.toLowerCase())>-1}}else if(v.startsWith("matches-")){var E=v.substring(8);var F=new RegExp(E,"i");return function(ka){var la=ka.attr("m");return F.test(la.toLowerCase())}}else if(v.startsWith("region-")){regionFilter=true;var G=v.substring(7);var H=$geo.find("r[n='"+G+"']");window.regionElement=H;return function(ma){var na=ma.attr("r");return H.is('[id="'+na+'"]')||H.has('r[id="'+na+'"]').length>0}}else if(v.startsWith("athlete-")){var I=v.substring(8);if(typeof athleteData[I]==="undefined"){$.ajax({url:"https://www.parkrun.org.uk:443/results/athleteeventresultshistory/?athleteNumber="+I+"&eventNumber=0",async:false}).done(function(oa){athleteData[I]=$(oa)})}return function(pa){return athleteData[I].find("a[href$='/"+pa.attr("n")+"/results']").length>0}}else if(v.startsWith("within-")){withinFilter=true;var J=v.substring(7);var K,M,N;if(isNaN(J)){var O=J.indexOf("-");K=J.substring(0,O);var P=J.substring(O+1).split(",");M=P[0];N=P[1]}else{K=parseInt(v.substring(7));if(position===undefined){K=0;M=0;N=0}else{M=position.coords.latitude;N=position.coords.longitude}}var Q=L.icon({iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-orange.png",shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});var R=L.marker([M,N],{icon:Q});R.addTo(markerGroup);return function(qa){var ra=parseFloat(qa.attr("lo"));var sa=parseFloat(qa.attr("la"));return getDistanceFromLatLonInKm(sa,ra,M,N)<K}}else if(v.startsWith("closest")){withinFilter=true;var S=v.substring(8);if(isNaN(S)){var O=S.indexOf("-");var T=S.substring(O+1).split(",");closestLatitude=T[0];closestLongitude=T[1];delete T;S=S.substring(0,O)}else{if(position===undefined){S=0;closestLatitude=0;closestLongitude=0}else{cloest=parseInt(v.substring(8));closestLatitude=position.coords.latitude;closestLongitude=position.coords.longitude}}var U=[];var V=[];var W=[];if(position===undefined){K=0;M=0;N=0}else{M=position.coords.latitude;N=position.coords.longitude}$geo.find("e").each(function(){var ta=$(this);var ua=parseFloat(ta.attr("lo"));var va=parseFloat(ta.attr("la"));var wa=getDistanceFromLatLonInKm(va,ua,closestLatitude,closestLongitude);V.push({id:ta.attr("id"),distance:wa})});W=V.sort(function(xa,ya){return xa.distance-ya.distance}).slice(0,S);delete V;for(var X=0;X<W.length;X++){console.info($geo.find("e[id='"+W[X].id+"']").attr("m"));U.push(W[X].id)}delete W;var Q=L.icon({iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png",shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});var R=L.marker([closestLatitude,closestLongitude],{icon:Q});R.addTo(markerGroup);return function(za){return U.indexOf(za.attr("id"))>-1}}else if(v==="none"){return function(){return false}}else if(v==="all"){return function(){return true}}}function getDistanceFromLatLonInKm(Aa,Ba,Ca,Da){var Ea=6371;var Fa=deg2rad(Ca-Aa);var Ga=deg2rad(Da-Ba);var Ha=Math.sin(Fa/2)*Math.sin(Fa/2)+Math.cos(deg2rad(Aa))*Math.cos(deg2rad(Ca))*Math.sin(Ga/2)*Math.sin(Ga/2);var Ia=2*Math.atan2(Math.sqrt(Ha),Math.sqrt(1-Ha));var Ja=Ea*Ia;return Ja}function deg2rad(Ka){return Ka*(Math.PI/180)}function load(){$(document).ready(function(){markerGroup.clearLayers();var La=decodeURIComponent(window.location.hash);filters=[];regionFilter=false;withinFilter=false;La.split("#").filter(function(Ma){return Ma}).forEach(function(Na){var Oa=getFilter(Na);if(Oa!==undefined){filters.push(Oa)}});if(filters.length>0){displayEvents(filters)}})}function init(){$(window).bind("hashchange",function(Pa){load()});$.ajax({url:"geo.xml",async:false}).done(function(Qa){$geo=$(Qa);var Ra=$('<div class="countries"><h4>Countries</h4></div>');$(".nav .controls").append(Ra);$geo.find("r[id=1] > r").each(function(){var Sa=$(this);var Ta=Sa.attr("id");var Ua=Sa.attr("n");var Va=$("<input type='checkbox' />");if(Ua=="UK"){Va.attr("checked","")}Va.attr("data-region-id-"+Ta,"");$geo.find("r[id="+Ta+"] r").each(function(){$region=$(this);Va.attr("data-region-id-"+$region.attr("id"),"")});Ra.append(Va).append($("<span />").text(Ua)).append($("<br />"));Va.change(function(){load()})})});$("#letter-prefix").keypress(function(Wa){if(Wa.which==13){var Xa=$("#letter-prefix").val();var Xa=Array.from(new Set(Xa.toLowerCase().replace(/[^a-z]/gi,"").split(""))).join("");window.location.hash="#matches-^["+Xa+"]"}});$("#search").keypress(function(Ya){if(Ya.which==13){var Za=$("#search").val();window.location.hash="#matches-.*"+Za+".*"}})}function initAndLoad(){init();load()}
