var mymap;var markerGroup;var $geo;var options;var athleteData=[];var filters=[];var position;var regionFilter;var withinFilter;navigator.geolocation.getCurrentPosition(function(a){position=a;initAndLoad()},function(b){initAndLoad()});$(document).ready(function(){initAjaxPrefilter();initOptions();initMap();centreMap();initAndLoad()});function initAjaxPrefilter(){jQuery.ajaxPrefilter(function(c){if(c.crossDomain&&jQuery.support.cors){c.url="https://cors-anywhere.herokuapp.com/"+c.url}})}function initOptions(){options=JSON.parse(Cookies.get("options")||"{}")}function initMap(){mymap=L.map("mapid",{zoomControl:false,maxBounds:new L.LatLngBounds(new L.LatLng(-90,-180),new L.LatLng(90,180)),minZoom:2});L.control.zoom({position:"topright"}).addTo(mymap);markerGroup=L.featureGroup().addTo(mymap);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:15,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(mymap);L.control.sidebar("sidebar").addTo(mymap);mymap.on("contextmenu",function(d){window.location.hash="#closest-5-"+d.latlng.lat+","+d.latlng.lng})}function centreMap(){if(position){mymap.fitBounds([[position.coords.latitude-.01,position.coords.longitude-.01],[position.coords.latitude+.01,position.coords.longitude+.01]])}else{mymap.fitBounds([[49.095026,-7.742293],[60.258081000000004,1.847338]])}}function displayEvents(e){var f=0;$geo.find("e").each(function(){var g=$(this);var h=g.attr("m");var i=g.attr("r");if(i!=""){var j=$geo.find("r[id="+i+"]").closest("r[u!='']").attr("u")}var k=$("[data-region-id-"+i+"]");var l=k.prop("checked");var m=false;if(l||regionFilter||withinFilter){m=true;for(var n=0;n<e.length;n++){if(m){var o=e[n](g);m=m&&o}}}if(m){var p=parseFloat(g.attr("lo"));var q=parseFloat(g.attr("la"));console.info(g.attr("n"));if(!isNaN(p)&&!isNaN(q)){addMarker(q,p,h,"blue",g);f++}}});if(f>0){mymap.fitBounds(markerGroup.getBounds());console.info(f+" events displayed")}else{console.info("no events displayed")}}function addMarker(r,s,t,u,v){var w=L.icon({iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-"+u+".png",shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});var x=L.marker([r,s],{icon:w});var y;if(typeof v!=="undefined"){var z=v.attr("n");var A=v.attr("r");if(A!=""){var B=$geo.find("r[id="+A+"]").closest("r[u!='']").attr("u")}y='<strong><a target="_blank" href="'+B+"/"+z+'/">'+t+'</a></strong><br /><a target="_blank" href="'+B+"/"+z+'/course/">Course page</a><br /><a target="_blank" href="'+B+"/"+z+'/futureroster/">Future Roster</a><br /><a target="_blank" href="https://www.google.com/maps/dir/?api=1&destination='+r+","+s+'">Directions</a>'}else if(typeof t!=="undefined"){y=t}if(options.vegan){if(typeof y!=="undefined"){y+="<br />"}y+='<a target="_blank" href="https://www.happycow.net/searchmap?lat='+r+"&lng="+s+'&vegan=true">Local vegan food</a>'}if(options.nationaltrust){if(typeof y!=="undefined"){y+="<br />"}y+='<a target="_blank" href="https://www.nationaltrust.org.uk/search?lat='+r+"&lon="+s+'&type=place&view=map">National Trust venues</a>'}if(options.premierinn){if(typeof y!=="undefined"){y+="<br />"}y+='<a target="_blank" href="https://www.premierinn.com/gb/en/search.html?&LOCATION='+r+","+s+'">Local Premier Inns</a>'}x.bindPopup(y);x.addTo(markerGroup)}function getFilter(C){if(C.startsWith("not-")){var D=C.substring(4);var E=getFilter(D);return function(ca){return!E(ca)}}else if(C.startsWith("and-")){var F=C.substring(4);var G=[];F.split("&&").filter(function(da){return da}).forEach(function(ea){G.push(getFilter(ea))});return function(fa){for(var ga=0;ga<G.length;ga++){if(!G[ga](fa)){return false}}return true}}else if(C.startsWith("or-")){var H=C.substring(3);var I=[];H.split("||").filter(function(ha){return ha}).forEach(function(ia){I.push(getFilter(ia))});return function(ja){for(var ka=0;ka<I.length;ka++){if(I[ka](ja)){return true}}return false}}else if(C.startsWith("startsWith-")){var J=C.substring(11);return function(la){var ma=la.attr("m");return ma.toLowerCase().startsWith(J.toLowerCase())}}else if(C.startsWith("contains-")){var K=C.substring(9);return function(na){var oa=na.attr("m");return oa.toLowerCase().indexOf(K.toLowerCase())>-1}}else if(C.startsWith("matches-")){var M=C.substring(8);var N=new RegExp(M,"i");return function(pa){var qa=pa.attr("m");return N.test(qa.toLowerCase())}}else if(C.startsWith("region-")){regionFilter=true;var O=C.substring(7);var P=$geo.find("r[n='"+O+"']");window.regionElement=P;return function(ra){var sa=ra.attr("r");return P.is('[id="'+sa+'"]')||P.has('r[id="'+sa+'"]').length>0}}else if(C.startsWith("athlete")){var Q;if(C=="athlete"){Q=options.athleteId}else{Q=C.substring(8)}if(typeof athleteData[Q]==="undefined"){$.ajax({url:"https://www.parkrun.org.uk:443/results/athleteeventresultshistory/?athleteNumber="+Q+"&eventNumber=0",async:false}).done(function(ta){athleteData[Q]=$(ta)})}return function(ua){return athleteData[Q].find("a[href$='/"+ua.attr("n")+"/results']").length>0}}else if(C.startsWith("within-")){withinFilter=true;var R=C.substring(7);var S,T,U;if(isNaN(R)){var V=R.indexOf("-");S=R.substring(0,V);var W=R.substring(V+1).split(",");T=W[0];U=W[1]}else{S=parseInt(C.substring(7));if(position===undefined){S=0;T=0;U=0}else{T=position.coords.latitude;U=position.coords.longitude}}addMarker(T,U,"Within "+S+"km","orange");return function(va){var wa=parseFloat(va.attr("lo"));var xa=parseFloat(va.attr("la"));return getDistanceFromLatLonInKm(xa,wa,T,U)<S}}else if(C.startsWith("closest")){withinFilter=true;var X=C.substring(8);if(isNaN(X)){var V=X.indexOf("-");var Y=X.substring(V+1).split(",");closestLatitude=Y[0];closestLongitude=Y[1];delete Y;X=X.substring(0,V)}else{if(position===undefined){X=0;closestLatitude=0;closestLongitude=0}else{if(position===undefined){X=0;closestLatitude=0;closestLongitude=0}else{X=parseInt(C.substring(8));closestLatitude=position.coords.latitude;closestLongitude=position.coords.longitude}}}var Z=[];var _=[];var aa=[];console.info("Looking for the closest "+X+" events to "+closestLatitude+","+closestLongitude);$geo.find('e[lo!=""][la!=""]').each(function(){var ya=$(this);var za=parseFloat(ya.attr("lo"));var Aa=parseFloat(ya.attr("la"));var Ba=getDistanceFromLatLonInKm(Aa,za,closestLatitude,closestLongitude);_.push({id:ya.attr("id"),distance:Ba})});aa=_.sort(function(Ca,Da){return Ca.distance-Da.distance}).slice(0,X);delete _;for(var ba=0;ba<aa.length;ba++){Z.push(aa[ba].id)}delete aa;addMarker(closestLatitude,closestLongitude,"Closest "+X+" event ","green");return function(Ea){return Z.indexOf(Ea.attr("id"))>-1}}else if(C==="none"){return function(){return false}}else if(C==="all"){return function(){return true}}}function getDistanceFromLatLonInKm(Fa,Ga,Ha,Ia){var Ja=6371;var Ka=deg2rad(Ha-Fa);var La=deg2rad(Ia-Ga);var Ma=Math.sin(Ka/2)*Math.sin(Ka/2)+Math.cos(deg2rad(Fa))*Math.cos(deg2rad(Ha))*Math.sin(La/2)*Math.sin(La/2);var Na=2*Math.atan2(Math.sqrt(Ma),Math.sqrt(1-Ma));var Oa=Ja*Na;return Oa}function deg2rad(Pa){return Pa*(Math.PI/180)}function load(){$(document).ready(function(){markerGroup.clearLayers();var Qa=decodeURIComponent(window.location.hash);filters=[];regionFilter=false;withinFilter=false;Qa.split("#").filter(function(Ra){return Ra}).forEach(function(Sa){var Ta=getFilter(Sa);if(Ta!==undefined){filters.push(Ta)}});if(filters.length>0){displayEvents(filters)}})}function init(){$(window).bind("hashchange",function(Ua){load()});$.ajax({url:"https://www.parkrun.org.uk/wp-content/themes/parkrun/xml/geo.xml",async:false}).done(function(Va){$geo=$(Va);var Wa=$('<div class="countries"><h4>Countries</h4></div>');$(".nav .controls").append(Wa);$geo.find("r[id=1] > r").each(function(){var Xa=$(this);var Ya=Xa.attr("id");var Za=Xa.attr("n");var $a=$("<input type='checkbox' />");if(Za=="UK"){$a.attr("checked","")}$a.attr("data-region-id-"+Ya,"");$geo.find("r[id="+Ya+"] r").each(function(){$region=$(this);$a.attr("data-region-id-"+$region.attr("id"),"")});Wa.append($a).append($("<span />").text(Za)).append($("<br />"));$a.change(function(){load()})})});$("#letter-prefix").keypress(function(_a){if(_a.which==13){var ab=$("#letter-prefix").val();var ab=Array.from(new Set(ab.toLowerCase().replace(/[^a-z]/gi,"").split(""))).join("");window.location.hash="#matches-^["+ab+"]"}});$("#search").keypress(function(bb){if(bb.which==13){var cb=$("#search").val();window.location.hash="#matches-.*"+cb+".*"}})}function initAndLoad(){init();load()}
