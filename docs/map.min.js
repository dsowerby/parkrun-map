var mymap;var markerGroup;var $geo;var options;var athleteData=[];var filters=[];var position;var hamburger;var withinFilter;var closestFilter;var events;var xmas;var nyd;var cancelled;var specialEvents;function parseName(a){if(typeof a!=="undefined"){return a.properties.EventShortName}return undefined}function parseLongName(b){if(typeof b!=="undefined"){return b.properties.EventLongName}return undefined}function parseEventId(c){if(typeof c!=="undefined"){return c.properties.eventname}return undefined}function parseLongitude(d){if(typeof d!=="undefined"){return parseFloat(d.geometry.coordinates[0])}return undefined}function parseLatitude(e){if(typeof e!=="undefined"){return parseFloat(e.geometry.coordinates[1])}return undefined}function parseCountrycode(f){if(typeof f!=="undefined"){return f.properties.countrycode}return undefined}function parseEventUrl(g){var h=parseEventId(g);var i=parseCountrycode(g);var j=countries[i];return"//"+j.url+"/"+h}function parseSeriesId(k){return k.properties.seriesid}$(document).ready(function(){initOptions();initMap();initBurger();centreMap();initAndLoad()});navigator.geolocation.getCurrentPosition(function(l){position=l;initAndLoad()},function(m){console.info("Error looking up location"+m);initAndLoad()});function initOptions(){options=JSON.parse(Cookies.get("options")||"{}")}function initBurger(){hamburger={navToggle:document.querySelector(".nav-toggle"),nav:document.querySelector(".nav"),doToggle:function(n){n.preventDefault();this.navToggle.classList.toggle("expanded");this.nav.classList.toggle("expanded")},show:function(){this.navToggle.classList.add("expanded");this.nav.classList.add("expanded")},hide:function(){this.navToggle.classList.remove("expanded");this.nav.classList.remove("expanded")}};hamburger.navToggle.addEventListener("click",function(o){hamburger.doToggle(o)})}function initMap(){mymap=L.map("mapid",{fullscreenControl:true,fullscreenControlOptions:{position:"topright"},zoomControl:false,maxBounds:new L.LatLngBounds(new L.LatLng(-90,-180),new L.LatLng(90,180)),minZoom:2});L.control.zoom({position:"topright"}).addTo(mymap);markerGroup=L.featureGroup().addTo(mymap);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(mymap);mymap.on("contextmenu",function(p){window.location.hash="#closest-5-"+p.latlng.lat+","+p.latlng.lng})}function centreMap(){if(position){mymap.fitBounds([[position.coords.latitude-.01,position.coords.longitude-.01],[position.coords.latitude+.01,position.coords.longitude+.01]])}else{mymap.fitBounds([[49.095026,-7.742293],[60.258081000000004,1.847338]])}}function displayEvents(q){if(q.length==0){return}var r=0;var s=$events.features;console.info("initial size: "+s.length);console.info("processing with "+q.length+" filters");for(var t=0;t<q.length;t++){var u=[];var v=q[t];s=v(s);console.info("after filter "+t+" there are "+s.length+" events")}if(q.length>0){console.info("after all filters there are "+s.length+" events")}window.events=s;for(var w=0;w<s.length;w++){var x=s[w];var y=parseLongitude(x);var z=parseLatitude(x);var A=parseName(x);addMarker(z,y,A,"blue",x);r++}if(r>0){mymap.fitBounds(markerGroup.getBounds());hamburger.hide();console.info(r+" events displayed")}else{hamburger.show();console.info("no events displayed")}}function addMarker(B,C,D,E,F){var G=L.icon({iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-"+E+".png",shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});var H=L.marker([B,C],{icon:G});var I;if(typeof F!=="undefined"){var J=parseEventUrl(F);I='<strong><a target="_blank" href="'+J+'/">'+D+"</a></strong><br />";I+='<a target="_blank" href="'+J+'/course/">Course page</a><br />';I+='<a target="_blank" href="'+J+'/futureroster/">Future Roster</a><br />';I+='<a target="_blank" href="'+J+'/results/eventhistory/">Event History</a><br />';I+='<a target="_blank" href="https://www.facebook.com/search/top/?q='+encodeURIComponent(D)+'%20parkrun&epa=SEARCH_BOX">Facebook</a><br />';I+='<a target="_blank" href="https://www.youtube.com/results?search_query='+encodeURIComponent(D)+'%20parkrun">YouTube</a>'}else if(typeof D!=="undefined"){I=D}I+='<br /><a target="_blank" href="https://www.google.com/maps/dir/?api=1&destination='+B+","+C+'">Directions</a><br />';I+='<a target="_blank" href="./weather#'+B+","+C+'">Weather Forecast</a><br />';I+='<a target="_blank" href="https://www.happycow.net/searchmap?lat='+B+"&lng="+C+'&vegan=true">Local vegan food</a><br />';I+='<a target="_blank" href="https://www.nationaltrust.org.uk/search?type=place&lat='+B+"&lon="+C+'&view=map">National Trust venues</a><br />';I+='<a target="_blank" href="https://www.nationaltrust.org.uk/search?type=place&lat='+B+"&lon="+C+'&filter=houses-and-buildings&view=map">National Trust houses</a><br />';I+='<a target="_blank" href="https://www.premierinn.com/gb/en/search.html?&LOCATION='+B+","+C+'">Local Premier Inns</a><br />';I+='<a target="_blank" href="https://www.pitchup.com/search/?sort=&lat='+B+"&lng="+C+'&facet=toilet-block&facet=adults-only&facet=shower-available&within=40&q=&type=4&adults=2&children=0">Tent site</a>';H.bindPopup(I);H.addTo(markerGroup)}function filterEvents(K,M){return function(N){var O=[];for(var P=0;P<N.length;P++){var Q=N[P];if(M(Q)){O.push(Q)}}return O}}function getFilter(R){if(R.startsWith("seriesid")){var S=R.substring(9);return filterEvents(events,function(qa){var ra=parseSeriesId(qa);return ra==S})}else if(R.startsWith("not-")){var T=R.substring(4);var U=getFilter(T);return function(sa){var ta=U(sa);return _.differenceWith(sa,ta,function(ua,va){return parseEventId(ua)==parseEventId(va)})}}else if(R.startsWith("and-")){var V=R.substring(4);var W=[];V.split("&&").filter(function(wa){return wa}).forEach(function(xa){W.push(getFilter(xa))});return function(ya){var za=ya;for(var Aa=0;Aa<W.length;Aa++){za=W[Aa](za)}return za}}else if(R.startsWith("or-")){var X=R.substring(3);var Y=[];X.split("||").filter(function(Ba){return Ba}).forEach(function(Ca){Y.push(getFilter(Ca))});return function(Da){orFilterResults=[];for(var Ea=0;Ea<Y.length;Ea++){orFilterResults=_.union(orFilterResults,Y[Ea](Da))}return orFilterResults}}else if(R.startsWith("startsWith-")){var Z=R.substring(11);return filterEvents(events,function(Fa){var Ga=parseName(Fa);return Ga.toLowerCase().startsWith(Z.toLowerCase())||Ga.toLowerCase().startsWith("parkrun "+Z.toLowerCase())})}else if(R.startsWith("contains-")){var aa=R.substring(9);return filterEvents(events,function(Ha){var Ia=parseName(Ha);return Ia.toLowerCase().indexOf(aa.toLowerCase())>-1})}else if(R.startsWith("matches-")){var ba=R.substring(8);var ca=new RegExp(ba,"i");return filterEvents(events,function(Ja){var Ka=parseName(Ja);var La=parseLongName(Ja);return ca.test(Ka.toLowerCase())||ca.test(La.toLowerCase())})}else if(R.startsWith("country-")){var da=R.substring(8);var ea;switch(da.toLowerCase()){case"austria":case"at":ea=4;break;case"australia":case"au":ea=3;break;case"canada":case"ca":ea=14;break;case"denmark":case"dk":ea=23;break;case"finland":case"fi":ea=30;break;case"france":case"fr":ea=31;break;case"germany":case"de":ea=32;break;case"ireland":case"ie":ea=42;break;case"italy":case"it":ea=44;break;case"japan":case"ja":ea=46;break;case"lithuania":case"lt":ea=54;break;case"malaysia":case"my":ea=57;break;case"netherlands":case"nl":ea=64;break;case"new-zealand":case"new zealand":case"nz":ea=65;break;case"norway":case"no":ea=67;break;case"poland":case"pl":ea=74;break;case"russia":case"ru":ea=79;break;case"singapore":case"sg":ea=82;break;case"south africa":case"south-africa":case"za":ea=85;break;case"sweden":case"se":ea=88;break;case"united kingdom":case"united-kingdom":case"uk":ea=97;break;case"united states":case"united-states":case"usa":case"us":ea=98;break}return filterEvents(events,function(Ma){return ea===parseCountrycode(Ma)})}else if(R=="cancelled"){if(typeof cancelled==="undefined"){$.ajax({url:"https://cors-anywhere.herokuapp.com/https://www.parkrun.org.uk/cancellations/",async:false}).done(function(Na){cancelled=$(Na)})}return filterEvents(events,function(Oa){var Pa=parseEventUrl(Oa)+"/";return cancelled.find("#main > #primary > #content > div.floatleft.left > ul:nth-child(4), #main > #primary > #content > div.floatleft.left > ul:nth-child(6)").find("li>a[href*='"+Pa+"']").length>0})}else if(R=="nyd"){if(typeof nyd==="undefined"){$.ajax({url:"https://cors-anywhere.herokuapp.com/https://www.parkrun.org.uk/special-events/",async:false}).done(function(Qa){specialEvents=$(Qa);xmas=$(Qa);xmas.find("#content .sortable tbody").addClass("events");xmas.find(".events td:nth-child(3):not(:contains(':'))").parent().remove();xmas.find(".events td>a[href$='/news/tag/newyear']").each(function(Ra,Sa){console.info("xmas "+$(Sa).attr("href"))});nyd=$(Qa);nyd.find("#content .sortable tbody").addClass("events");nyd.find(".events td:nth-child(4):not(:contains(':'))").parent().remove();nyd.find(".events td>a[href$='/news/tag/newyear']").each(function(Ta,Ua){console.info("nyd "+$(Ua).attr("href"))})})}return filterEvents(events,function(Va){var Wa=parseEventId(Va);return nyd.find("td>a[href='https://www.parkrun.org.uk/"+Wa+"/']").length>0})}else if(R=="xmas"){if(typeof xmas==="undefined"){$.ajax({url:"https://cors-anywhere.herokuapp.com/https://www.parkrun.org.uk/special-events/",async:false}).done(function(Xa){specialEvents=$(Xa);xmas=$(Xa);xmas.find("#content .sortable tbody").addClass("events");xmas.find(".events td:nth-child(3):not(:contains(':'))").parent().remove();xmas.find(".events td>a[href$='/news/tag/christmas']").each(function(Ya,Za){console.info("xmas "+$(Za).attr("href"))});nyd=$(Xa);nyd.find("#content .sortable tbody").addClass("events");nyd.find(".events td:nth-child(4):not(:contains(':'))").parent().remove();nyd.find(".events td>a[href$='/news/tag/newyear']").each(function($a,_a){console.info("nyd "+$(_a).attr("href"))})})}return filterEvents(events,function(a0){var b0=parseEventId(a0);return xmas.find("td>a[href='https://www.parkrun.org.uk/"+b0+"/']").length>0})}else if(R.startsWith("athlete")){var fa;if(R=="athlete"){fa=options.athleteId}else{fa=R.substring(8).trim();if(fa.toUpperCase().startsWith("A")){fa=fa.substring(1)}}if(typeof athleteData[fa]==="undefined"){$.ajax({url:"./athletes/"+fa+".json",async:false}).done(function(c0){athleteData[fa]=c0})}return filterEvents(events,function(d0){var e0=parseEventId(d0);return athleteData[fa].includes(e0)})}else if(R.startsWith("within-")){withinFilter=true;var ga=R.substring(7);var ha,ia,ja;if(isNaN(ga)){var ka=ga.indexOf("-");ha=ga.substring(0,ka);var la=ga.substring(ka+1).split(",");ia=la[0];ja=la[1]}else{ha=parseInt(R.substring(7));if(position===undefined){ha=0;ia=0;ja=0}else{ia=position.coords.latitude;ja=position.coords.longitude}}addMarker(ia,ja,"Within "+ha+"km","orange");return filterEvents(events,function(f0){var g0=parseLatitude(f0);var h0=parseLongitude(f0);return getDistanceFromLatLonInKm(g0,h0,ia,ja)<ha})}else if(R=="compass"){return function(i0){var j0={};var k0={};var l0={};var m0={};for(var n0=0;n0<i0.length;n0++){var o0=i0[n0];var p0=parseLatitude(o0);var q0=parseLongitude(o0);if(isNaN(j0.latitude)||j0.latitude<p0){j0.longitude=q0;j0.latitude=p0;j0.id=parseEventId(o0);j0.event=o0}if(isNaN(l0.longitude)||l0.longitude<q0){l0.longitude=q0;l0.latitude=p0;l0.id=parseEventId(o0);l0.event=o0}if(isNaN(k0.latitude)||k0.latitude>p0){k0.longitude=q0;k0.latitude=p0;k0.id=parseEventId(o0);k0.event=o0}if(isNaN(m0.longitude)||m0.longitude>q0){m0.longitude=q0;m0.latitude=p0;m0.id=parseEventId(o0);m0.event=o0}}var i0=[j0.event,l0.event,k0.event,m0.event];return _.uniq(i0)}}else if(R.startsWith("closest")){closestFilter=true;var ma=R.substring(8);if(isNaN(ma)){var ka=ma.indexOf("-");var na=ma.substring(ka+1).split(",");closestLatitude=na[0];closestLongitude=na[1];delete na;ma=ma.substring(0,ka)}else{if(position===undefined){ma=0;closestLatitude=0;closestLongitude=0}else{if(position===undefined){ma=0;closestLatitude=0;closestLongitude=0}else{ma=parseInt(R.substring(8));closestLatitude=position.coords.latitude;closestLongitude=position.coords.longitude}}}return function(r0){var s0=[];for(var t0=0;t0<r0.length;t0++){$event=r0[t0];var u0=parseLatitude($event);var v0=parseLongitude($event);var w0=getDistanceFromLatLonInKm(u0,v0,closestLatitude,closestLongitude);s0.push({event:$event,distance:w0})}var x0=s0.sort(function(A0,B0){return A0.distance-B0.distance});var y0=[];if(s0.length<ma){ma=s0.length}addMarker(closestLatitude,closestLongitude,"Closest "+ma+" event ","green");for(var z0=0;z0<ma;z0++){y0.push(s0[z0].event)}return y0}}else if(R=="random"){return function(C0){var D0=_.random(C0.length-1);return[C0[D0]]}}else if(R==="none"){return filterEvents(events,function(E0){return[]})}else if(R==="all"){return function(F0){return F0}}else if(R.startsWith("pin-")){var oa=R.substring(4);var ka=oa.indexOf("-");pinColour=oa.substring(0,ka);var pa=oa.substring(ka+1).split(",");pinLatitude=pa[0];pinLongitude=pa[1];addMarker(pinLatitude,pinLongitude,"Pinned location",pinColour);return function(G0){return G0}}}function getDistanceFromLatLonInKm(H0,I0,J0,K0){var L0=6371;var M0=deg2rad(J0-H0);var N0=deg2rad(K0-I0);var O0=Math.sin(M0/2)*Math.sin(M0/2)+Math.cos(deg2rad(H0))*Math.cos(deg2rad(J0))*Math.sin(N0/2)*Math.sin(N0/2);var P0=2*Math.atan2(Math.sqrt(O0),Math.sqrt(1-O0));var Q0=L0*P0;return Q0}function deg2rad(R0){return R0*(Math.PI/180)}function load(){$(document).ready(function(){markerGroup.clearLayers();var S0=decodeURIComponent(window.location.hash);filters=[];regionFilter=false;withinFilter=false;closestFilter=false;var T0=0;S0.split("#").filter(function(U0){return U0}).forEach(function(V0){console.info("filter "+T0+" "+V0);var W0=getFilter(V0);if(W0!==undefined){filters.push(W0)}T0++});displayEvents(filters)})}function init(){$(window).bind("hashchange",function(X0){load()});$.ajax({url:"./events.json",async:false}).done(function(Y0){$events=Y0.events;countries=Y0.countries});$("#letter-prefix").keypress(function(Z0){if(Z0.which==13){var $0=$("#letter-prefix").val();var $0=Array.from(new Set($0.toLowerCase().replace(/[^a-z]/gi,"").split(""))).join("");window.location.hash="#matches-^["+$0+"]"}});$("#search").keypress(function(_0){if(_0.which==13){var ab=$("#search").val();window.location.hash="#matches-.*"+ab+".*"}});$("#athlete").keypress(function(bb){if(bb.which==13){var cb=$("#athlete").val();window.location.hash="#athlete-"+cb}})}function initAndLoad(){init();load()}
