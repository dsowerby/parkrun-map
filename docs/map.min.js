var completedEvents=[];var mymap;var markerGroup;var $geo;var options;var athleteData=[];$(document).ready(function(){initAjaxPrefilter();initOptions();initMap();initBurger();centerOnUK();initAndLoad()});function initAjaxPrefilter(){jQuery.ajaxPrefilter(function(a){if(a.crossDomain&&jQuery.support.cors){a.url="https://cors-anywhere.herokuapp.com/"+a.url}})}function initOptions(){options=JSON.parse(Cookies.get("options")||"{}")}function initBurger(){var b={navToggle:document.querySelector(".nav-toggle"),nav:document.querySelector(".nav"),doToggle:function(c){c.preventDefault();this.navToggle.classList.toggle("expanded");this.nav.classList.toggle("expanded")}};b.navToggle.addEventListener("click",function(d){b.doToggle(d)})}function initMap(){mymap=L.map("mapid",{zoomControl:false,maxBounds:new L.LatLngBounds(new L.LatLng(-90,-180),new L.LatLng(90,180)),minZoom:2});L.control.zoom({position:"topright"}).addTo(mymap);markerGroup=L.layerGroup().addTo(mymap);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(mymap)}function centerOnUK(){mymap.fitBounds([[49.095026,-7.742293],[60.258081000000004,1.847338]])}function displayEvents(e){markerGroup.clearLayers();var f=longitudeMax=latitudeMin=latitudeMax=undefined;var g=0;$geo.find("e").each(function(){var h=$(this);var i=h.attr("m");var j=h.attr("r");if(j!=""){var k=$geo.find("r[id="+j+"]").closest("r[u!='']").attr("u")}var l=$("[data-region-id-"+j+"]");var m=l.prop("checked")&&completedEvents.indexOf(i)==-1;var n=false;if(m){n=true;for(var o=0;o<e.length;o++){if(n){var p=e[o](h);n=n&&p}}}if(n){var q=h.attr("n");var r=parseFloat(h.attr("lo"));var s=parseFloat(h.attr("la"));if(!isNaN(r)&&!isNaN(s)){if(r<f||typeof f=="undefined"){f=r}if(s<latitudeMin||typeof latitudeMin=="undefined"){latitudeMin=s}if(r>longitudeMax||typeof longitudeMax=="undefined"){longitudeMax=r}if(s>latitudeMax||typeof latitudeMax=="undefined"){latitudeMax=s}var t=L.marker([s,r]);if(typeof k!==undefined){var u="<strong>"+i+'</strong><br /><a target="_blank" href="'+k+"/"+q+'">Course page</a><br /><a target="_blank" href="https://www.google.com/maps/dir/?api=1&destination='+s+","+r+'">Directions</a>';if(options.vegan){u+='<br /><a target="_blank" href="https://www.happycow.net/searchmap?lat='+s+"&lng="+r+'&vegan=true">Local vegan food</a>'}t.bindPopup(u)}else{t.bindPopup(i)}t.addTo(markerGroup);g++}}});if(g>0){latitudeMin=latitudeMin-.1;f=f-.1;latitudeMax=latitudeMax+.1;longitudeMax=longitudeMax+.1;mymap.fitBounds([[latitudeMin,f],[latitudeMax,longitudeMax]])}}$(window).bind("hashchange",function(v){load()});function getFilter(w){console.info("getFilter: "+w);if(w.startsWith("not-")){var x=w.substring(4);var y=getFilter(x);return function(I){return!y(I)}}else if(w.startsWith("or-")){var z=w.substring(3);var A=[];z.split("|").filter(function(J){return J}).forEach(function(K){A.push(getFilter(K))});return function(M){for(var N=0;N<A.length;N++){if(A[N](M)){return true}}return false}}else if(w.startsWith("startsWith-")){var B=w.substring(11);return function(O){var P=O.attr("m");return P.toLowerCase().startsWith(B.toLowerCase())}}else if(w.startsWith("contains-")){var C=w.substring(9);return function(Q){var R=Q.attr("m");return R.toLowerCase().indexOf(C.toLowerCase())>-1}}else if(w.startsWith("matches-")){var D=w.substring(8);var E=new RegExp(D,"i");return function(S){var T=S.attr("m");return E.test(T.toLowerCase())}}else if(w.startsWith("region-")){var F=w.substring(7);var G=$geo.find("r[n='"+F+"']").attr("id");return function(U){return G===U.attr("r")}}else if(w.startsWith("athlete-")){var H=w.substring(8);if(typeof athleteData[H]==="undefined"){$.ajax({url:"https://www.parkrun.org.uk:443/results/athleteeventresultshistory/?athleteNumber="+H+"&eventNumber=0",async:false}).done(function(V){athleteData[H]=$(V)})}return function(W){return athleteData[H].find("a[href$='/"+W.attr("n")+"/results']").length>0}}else if(w==="none"){return function(){return false}}else if(w==="all"){return function(){return true}}}function load(){$(document).ready(function(){var X=decodeURIComponent(window.location.hash);var Y=[];X.split("#").filter(function(Z){return Z}).forEach(function(_){Y.push(getFilter(_))});if(Y.length==0){Y.push(function(){return false})}displayEvents(Y)})}function init(){$.ajax({url:"geo.xml",async:false}).done(function(aa){$geo=$(aa);var ba=$('<div class="countries"><h4>Countries</h4></div>');$(".nav .controls").append(ba);$geo.find("r[id=1] > r").each(function(){var ca=$(this);var da=ca.attr("id");var ea=ca.attr("n");var fa=$("<input type='checkbox' />");if(ea=="UK"){fa.attr("checked","")}fa.attr("data-region-id-"+da,"");$geo.find("r[id="+da+"] r").each(function(){$region=$(this);fa.attr("data-region-id-"+$region.attr("id"),"")});ba.append(fa).append($("<span />").text(ea)).append($("<br />"));fa.change(function(){load()})})});$("#letter-prefix").keypress(function(ga){if(ga.which==13){var ha=$("#letter-prefix").val();var ha=Array.from(new Set(ha.toLowerCase().replace(/[^a-z]/gi,"").split(""))).join("");window.location.hash="#matches-^["+ha+"]"}});$("#search").keypress(function(ia){if(ia.which==13){var ja=$("#search").val();window.location.hash="#matches-.*"+ja+".*"}})}function initAndLoad(){init();load()}
