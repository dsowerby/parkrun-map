var mymap;var markerGroup;var $geo;var options;var athleteData=[];var filters=[];var position;var hamburger;var withinFilter;var closestFilter;var events;function parseName(a){if(typeof a!=="undefined"){return a.properties.EventLongName}return undefined}function parseEventId(b){if(typeof b!=="undefined"){return b.properties.eventName}return undefined}function parseLongitude(c){if(typeof c!=="undefined"){return parseFloat(c.geometry.coordinates[0])}return undefined}function parseLatitude(d){if(typeof d!=="undefined"){return parseFloat(d.geometry.coordinates[1])}return undefined}function parseCountrycode(e){if(typeof e!=="undefined"){return e.properties.countrycode}return undefined}function parseEventUrl(f){var g=parseEventId(f);var h=parseCountrycode(f);var i=countries[h];console.info(i.url);return"https://"+i.url+"/"+g}function parseSeriesId(j){return j.properties.seriesid}$(document).ready(function(){initOptions();initMap();initBurger();centreMap();initAndLoad()});navigator.geolocation.getCurrentPosition(function(k){position=k;initAndLoad()},function(l){initAndLoad()});function initOptions(){options=JSON.parse(Cookies.get("options")||"{}")}function initBurger(){hamburger={navToggle:document.querySelector(".nav-toggle"),nav:document.querySelector(".nav"),doToggle:function(m){m.preventDefault();this.navToggle.classList.toggle("expanded");this.nav.classList.toggle("expanded")},show:function(){this.navToggle.classList.add("expanded");this.nav.classList.add("expanded")},hide:function(){this.navToggle.classList.remove("expanded");this.nav.classList.remove("expanded")}};hamburger.navToggle.addEventListener("click",function(n){hamburger.doToggle(n)})}function initMap(){mymap=L.map("mapid",{fullscreenControl:true,fullscreenControlOptions:{position:"topright"},zoomControl:false,maxBounds:new L.LatLngBounds(new L.LatLng(-90,-180),new L.LatLng(90,180)),minZoom:2});L.control.zoom({position:"topright"}).addTo(mymap);markerGroup=L.featureGroup().addTo(mymap);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(mymap);mymap.on("contextmenu",function(o){window.location.hash="#closest-5-"+o.latlng.lat+","+o.latlng.lng})}function centreMap(){if(position){mymap.fitBounds([[position.coords.latitude-.01,position.coords.longitude-.01],[position.coords.latitude+.01,position.coords.longitude+.01]])}else{mymap.fitBounds([[49.095026,-7.742293],[60.258081000000004,1.847338]])}}function displayEvents(p){if(p.length==0){return}var q=0;var r=$events.features;console.info(r.length);console.info("initial size: "+r.length);console.info("processing with "+p.length+" filters");for(var s=0;s<p.length;s++){var t=[];var u=p[s];r=u(r);console.info("after filter "+s+" there are "+r.length+" events")}if(p.length>0){console.info("after all filters there are "+r.length+" events")}window.events=r;for(var v=0;v<r.length;v++){var w=r[v];var x=parseLongitude(w);var y=parseLatitude(w);var z=parseName(w);addMarker(y,x,z,"blue",w);q++}if(q>0){mymap.fitBounds(markerGroup.getBounds());hamburger.hide();console.info(q+" events displayed")}else{hamburger.show();console.info("no events displayed")}}function addMarker(A,B,C,D,E){var F=L.icon({iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-"+D+".png",shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});var G=L.marker([A,B],{icon:F});var H;if(typeof E!=="undefined"){var I=parseEventUrl(E);H='<strong><a target="_blank" href="'+I+'/">'+C+'</a></strong><br /><a target="_blank" href="'+I+'/course/">Course page</a><br /><a target="_blank" href="'+I+'/futureroster/">Future Roster</a><br /><a target="_blank" href="https://www.google.com/maps/dir/?api=1&destination='+A+","+B+'">Directions</a>'}else if(typeof C!=="undefined"){H=C}if(typeof H!=="undefined"){H+="<br />"}H+='<a target="_blank" href="https://www.happycow.net/searchmap?lat='+A+"&lng="+B+'&vegan=true">Local vegan food</a>';if(options.nationaltrust){if(typeof H!=="undefined"){H+="<br />"}H+='<a target="_blank" href="https://www.nationaltrust.org.uk/search?lat='+A+"&lon="+B+'&type=place&view=map">National Trust venues</a>';H+="<br />";H+='<a target="_blank" href="https://www.nationaltrust.org.uk/search?lat='+A+"&lon="+B+'&type=place&view=map&PlaceFilter=houses-and-buildings">National Trust houses</a>'}if(options.premierinn){if(typeof H!=="undefined"){H+="<br />"}H+='<a target="_blank" href="https://www.premierinn.com/gb/en/search.html?&LOCATION='+A+","+B+'">Local Premier Inns</a>'}G.bindPopup(H);G.addTo(markerGroup)}function filterEvents(J,K){return function(M){var N=[];for(var O=0;O<M.length;O++){var P=M[O];if(K(P)){N.push(P)}}return N}}function getFilter(Q){if(Q.startsWith("seriesid")){var R=Q.substring(9);return filterEvents(events,function(la){var ma=parseSeriesId(la);return ma==R})}else if(Q.startsWith("not-")){var S=Q.substring(4);var T=getFilter(S);return function(na){var oa=T(na);return _.differenceWith(na,oa,function(pa,qa){return parseEventId(pa)==parseEventId(qa)})}}else if(Q.startsWith("and-")){var U=Q.substring(4);var V=[];U.split("&&").filter(function(ra){return ra}).forEach(function(sa){V.push(getFilter(sa))});return function(ta){var ua=ta;for(var va=0;va<V.length;va++){ua=V[va](ua)}return ua}}else if(Q.startsWith("or-")){var W=Q.substring(3);var X=[];W.split("||").filter(function(wa){return wa}).forEach(function(xa){X.push(getFilter(xa))});return function(ya){orFilterResults=[];for(var za=0;za<X.length;za++){orFilterResults=_.union(orFilterResults,X[za](ya))}return orFilterResults}}else if(Q.startsWith("startsWith-")){var Y=Q.substring(11);return filterEvents(events,function(Aa){var Ba=parseName(Aa);return Ba.toLowerCase().startsWith(Y.toLowerCase())})}else if(Q.startsWith("contains-")){var Z=Q.substring(9);return filterEvents(events,function(Ca){var Da=parseName(Ca);return Da.toLowerCase().indexOf(Z.toLowerCase())>-1})}else if(Q.startsWith("matches-")){var aa=Q.substring(8);var ba=new RegExp(aa,"i");return filterEvents(events,function(Ea){var Fa=parseName(Ea);return ba.test(Fa.toLowerCase())})}else if(Q.startsWith("athlete")){var ca;if(Q=="athlete"){ca=options.athleteId}else{ca=Q.substring(8)}if(typeof athleteData[ca]==="undefined"){$.ajax({url:"https://cors-anywhere.herokuapp.com/http://www.parkrun.org.uk/results/athleteeventresultshistory/?athleteNumber="+ca+"&eventNumber=0",async:false}).done(function(Ga){athleteData[ca]=$(Ga)})}return filterEvents(events,function(Ha){var Ia=parseEventId(Ha);return athleteData[ca].find("a[href$='/"+Ia+"/results']").length>0})}else if(Q.startsWith("within-")){withinFilter=true;var da=Q.substring(7);var ea,fa,ga;if(isNaN(da)){var ha=da.indexOf("-");ea=da.substring(0,ha);var ia=da.substring(ha+1).split(",");fa=ia[0];ga=ia[1]}else{ea=parseInt(Q.substring(7));if(position===undefined){ea=0;fa=0;ga=0}else{fa=position.coords.latitude;ga=position.coords.longitude}}addMarker(fa,ga,"Within "+ea+"km","orange");return filterEvents(events,function(Ja){var Ka=parseLatitude(Ja);var La=parseLongitude(Ja);return getDistanceFromLatLonInKm(Ka,La,fa,ga)<ea})}else if(Q=="compass"){return function(Ma){var Na={};var Oa={};var Pa={};var Qa={};for(var Ra=0;Ra<Ma.length;Ra++){var Sa=Ma[Ra];var Ta=parseLatitude(Sa);var Ua=parseLongitude(Sa);if(isNaN(Na.latitude)||Na.latitude<Ta){Na.longitude=Ua;Na.latitude=Ta;Na.id=parseEventId(Sa);Na.event=Sa}if(isNaN(Pa.longitude)||Pa.longitude<Ua){Pa.longitude=Ua;Pa.latitude=Ta;Pa.id=parseEventId(Sa);Pa.event=Sa}if(isNaN(Oa.latitude)||Oa.latitude>Ta){Oa.longitude=Ua;Oa.latitude=Ta;Oa.id=parseEventId(Sa);Oa.event=Sa}if(isNaN(Qa.longitude)||Qa.longitude>Ua){Qa.longitude=Ua;Qa.latitude=Ta;Qa.id=parseEventId(Sa);Qa.event=Sa}}var Ma=[Na.event,Pa.event,Oa.event,Qa.event];return _.uniq(Ma)}}else if(Q.startsWith("closest")){closestFilter=true;var ja=Q.substring(8);if(isNaN(ja)){var ha=ja.indexOf("-");var ka=ja.substring(ha+1).split(",");closestLatitude=ka[0];closestLongitude=ka[1];delete ka;ja=ja.substring(0,ha)}else{if(position===undefined){ja=0;closestLatitude=0;closestLongitude=0}else{if(position===undefined){ja=0;closestLatitude=0;closestLongitude=0}else{ja=parseInt(Q.substring(8));closestLatitude=position.coords.latitude;closestLongitude=position.coords.longitude}}}return function(Va){var Wa=[];for(var Xa=0;Xa<Va.length;Xa++){$event=Va[Xa];var Ya=parseLatitude($event);var Za=parseLongitude($event);var $a=getDistanceFromLatLonInKm(Ya,Za,closestLatitude,closestLongitude);Wa.push({event:$event,distance:$a})}var _a=Wa.sort(function(cb,db){return cb.distance-db.distance});var ab=[];if(Wa.length<ja){ja=Wa.length}addMarker(closestLatitude,closestLongitude,"Closest "+ja+" event ","green");for(var bb=0;bb<ja;bb++){ab.push(Wa[bb].event)}return ab}}else if(Q=="random"){return function(eb){var fb=_.random(eb.length-1);return[eb[fb]]}}else if(Q==="none"){return filterEvents(events,function(gb){return[]})}else if(Q==="all"){return function(hb){return hb}}}function getDistanceFromLatLonInKm(ib,jb,kb,lb){var mb=6371;var nb=deg2rad(kb-ib);var ob=deg2rad(lb-jb);var pb=Math.sin(nb/2)*Math.sin(nb/2)+Math.cos(deg2rad(ib))*Math.cos(deg2rad(kb))*Math.sin(ob/2)*Math.sin(ob/2);var qb=2*Math.atan2(Math.sqrt(pb),Math.sqrt(1-pb));var rb=mb*qb;return rb}function deg2rad(sb){return sb*(Math.PI/180)}function load(){$(document).ready(function(){markerGroup.clearLayers();var tb=decodeURIComponent(window.location.hash);filters=[];regionFilter=false;withinFilter=false;closestFilter=false;var ub=0;tb.split("#").filter(function(vb){return vb}).forEach(function(wb){console.info("filter "+ub+" "+wb);var xb=getFilter(wb);if(xb!==undefined){filters.push(xb)}ub++});displayEvents(filters)})}function init(){$(window).bind("hashchange",function(yb){load()});$.ajax({url:"./events.json",async:false}).done(function(zb){$events=zb.events;countries=zb.countries});$("#letter-prefix").keypress(function(Ab){if(Ab.which==13){var Bb=$("#letter-prefix").val();var Bb=Array.from(new Set(Bb.toLowerCase().replace(/[^a-z]/gi,"").split(""))).join("");window.location.hash="#matches-^["+Bb+"]"}});$("#search").keypress(function(Cb){if(Cb.which==13){var Db=$("#search").val();window.location.hash="#matches-.*"+Db+".*"}})}function initAndLoad(){init();load()}
