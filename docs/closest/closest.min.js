var mymap;var events;var position;var options={};var events;var countries;var athleteData=[];var iconColours=["red","orange-dark","orange","yellow","blue-dark","cyan","purple","violet","pink","green-dark","green","black","white"];function parseName(a){if(typeof a!=="undefined"){return a.properties.EventLongName}return undefined}function parseEventId(b){if(typeof b!=="undefined"){return b.properties.eventname}return undefined}function parseLongitude(c){if(typeof c!=="undefined"){return parseFloat(c.geometry.coordinates[0])}return undefined}function parseLatitude(d){if(typeof d!=="undefined"){return parseFloat(d.geometry.coordinates[1])}return undefined}function parseCountrycode(e){if(typeof e!=="undefined"){return e.properties.countrycode}return undefined}function parseEventUrl(f){var g=parseEventId(f);var h=parseCountrycode(f);var i=countries[h];return"https://"+i.url+"/"+g}function parseSeriesId(j){return j.properties.seriesid}Array.prototype.getUnique=function(){var k={},l=[];for(var m=0;m<this.length;m++)k[this[m]]=1;for(var n in k)l.push(n);return l};navigator.geolocation.getCurrentPosition(function(o){position=o;initAndLoad()},function(p){initAndLoad()});$(document).ready(function(){initMap();initOptions();centreMap();initAndLoad()});function initOptions(){options=JSON.parse(Cookies.get("options")||"{}")}function initMap(){mymap=L.map("mapid",{fullscreenControl:true,zoomControl:false,maxBounds:new L.LatLngBounds(new L.LatLng(-90,-180),new L.LatLng(90,180)),minZoom:2});L.control.zoom({position:"topright"}).addTo(mymap);markerGroup=L.featureGroup().addTo(mymap);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(mymap);mymap.on("contextmenu",function(q){window.location.hash="#5-"+q.latlng.lat+","+q.latlng.lng})}function centreMap(){if(position){mymap.fitBounds([[position.coords.latitude-.01,position.coords.longitude-.01],[position.coords.latitude+.01,position.coords.longitude+.01]])}else{mymap.fitBounds([[49.095026,-7.742293],[60.258081000000004,1.847338]])}}function addDoneMarker(r,s,t,u){var v=L.ExtraMarkers.icon({markerColor:"green-light",icon:"fa-check",prefix:"fa"});addMarker(v,r,s,t,u)}function addIndexMarker(w,x,y,z,A,B){var C=L.ExtraMarkers.icon({markerColor:A,icon:"fa-number",number:w});addMarker(C,x,y,z,B)}function addMarker(D,E,F,G,H){var I=L.marker([E,F],{icon:D});var J;if(typeof H!=="undefined"){var K=parseEventUrl(H);J='<strong><a target="_blank" href="'+K+'/">'+G+'</a></strong><br /><a target="_blank" href="'+K+'/course/">Course page</a><br /><a target="_blank" href="'+K+'/futureroster/">Future Roster</a><br /><a target="_blank" href="'+K+'/results/eventhistory/">Event History</a><br /><a target="_blank" href="https://www.google.com/maps/dir/?api=1&destination='+E+","+F+'">Directions</a><br /><a target="_blank" href="../weather#'+E+","+F+'">Weather Forecast</a><br /><a target="_blank" href="https://www.facebook.com/search/top/?q='+G+'&epa=SEARCH_BOX">Facebook</a>'}else if(typeof G!=="undefined"){J=G}{if(typeof J!=="undefined"){J+="<br />"}J+='<a target="_blank" href="https://www.happycow.net/searchmap?lat='+E+"&lng="+F+'&vegan=true">Local vegan food</a>'}{if(typeof J!=="undefined"){J+="<br />"}J+='<a target="_blank" href="https://www.nationaltrust.org.uk/search?lat='+E+"&lon="+F+'&type=place&view=map">National Trust venues</a>';J+="<br />";J+='<a target="_blank" href="https://www.nationaltrust.org.uk/search?lat='+E+"&lon="+F+'&type=place&view=map&PlaceFilter=houses-and-buildings">National Trust houses</a>'}{if(typeof J!=="undefined"){J+="<br />"}J+='<a target="_blank" href="https://www.premierinn.com/gb/en/search.html?&LOCATION='+E+","+F+'">Local Premier Inns</a>'}{if(typeof J!=="undefined"){J+="<br />"}J+='<a target="_blank" href="https://www.pitchup.com/search/?sort=&lat='+E+"&lng="+F+'&facet=toilet-block&facet=adults-only&facet=shower-available&within=40&q=&type=4&adults=2&children=0">Tent site</a>'}I.bindPopup(J);I.addTo(markerGroup)}function displayEvents(M){if(isNaN(M)){var N=M.indexOf("-");var O=M.substring(N+1).split(",");closestLatitude=O[0];closestLongitude=O[1];delete O;M=M.substring(0,N)}else{if(position===undefined){M=0;closestLatitude=0;closestLongitude=0}else{M=parseInt(M);closestLatitude=position.coords.latitude;closestLongitude=position.coords.longitude}}var P=[];var Q=[];var R=[];for(var S=0;S<events.length;S++){var T=events[S];var U=parseLatitude(T);var V=parseLongitude(T);var W=getDistanceFromLatLonInKm(U,V,closestLatitude,closestLongitude);Q.push({id:parseEventId(T),distance:W})}R=Q.sort(function(aa,ba){return aa.distance-ba.distance});delete Q;for(var X=0;X<R.length;X++){P.push(R[X].id)}delete R;if(typeof(options.athleteId==="string")){if(typeof athleteData[options.athleteId]==="undefined"){$.ajax({url:"../athletes/"+options.athleteId+".json",async:false}).done(function(ca){athleteData[options.athleteId]=ca})}}var Y=0;P.forEach(function(da){if(Y<M){var ea;events.forEach(function(ha){var ia=parseEventId(ha);var ja=parseSeriesId(ha);if(ja===1&&ia===da){ea=ha;return}});if(typeof ea!=="undefined"){var fa=parseName(ea);var ga=false;if(typeof options.athleteId==="undefined"||typeof athleteData==="undefined"||typeof athleteData[options.athleteId]=="undefined"){ga=true}else if(!athleteData[options.athleteId].includes(parseEventId(ea))){ga=true}else{addDoneMarker(parseLatitude(ea),parseLongitude(ea),fa,ea)}if(ga){addIndexMarker(++Y,parseLatitude(ea),parseLongitude(ea),fa,iconColours[Y%iconColours.length-1],ea);console.info("index event "+Y+" "+fa)}}}});var Z=L.icon({iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png",shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});var _=L.marker([closestLatitude,closestLongitude],{icon:Z});_.addTo(markerGroup);mymap.fitBounds(markerGroup.getBounds())}function getDistanceFromLatLonInKm(ka,la,ma,na){var oa=6371;var pa=deg2rad(ma-ka);var qa=deg2rad(na-la);var ra=Math.sin(pa/2)*Math.sin(pa/2)+Math.cos(deg2rad(ka))*Math.cos(deg2rad(ma))*Math.sin(qa/2)*Math.sin(qa/2);var sa=2*Math.atan2(Math.sqrt(ra),Math.sqrt(1-ra));var ta=oa*sa;return ta}function deg2rad(ua){return ua*(Math.PI/180)}function load(){$(document).ready(function(){markerGroup.clearLayers();var va=decodeURIComponent(window.location.hash);var wa=va.substring(1);displayEvents(wa)})}function init(){$(window).bind("hashchange",function(xa){load()});$.ajax({url:"../events.json",async:false}).done(function(ya){events=ya.events.features;countries=ya.countries})}function initAndLoad(){init();load()}
