var mymap;var $geo;var position;var options={};var iconColours=["red","orange-dark","orange","yellow","blue-dark","cyan","purple","violet","pink","green-dark","green","green-light","black","white"];navigator.geolocation.getCurrentPosition(function(a){position=a;initAndLoad()},function(b){initAndLoad()});$(document).ready(function(){initMap();initOptions();centreMap();initAndLoad()});function initOptions(){options=JSON.parse(Cookies.get("options")||"{}")}function initMap(){mymap=L.map("mapid",{zoomControl:false,maxBounds:new L.LatLngBounds(new L.LatLng(-90,-180),new L.LatLng(90,180)),minZoom:2});L.control.zoom({position:"topright"}).addTo(mymap);markerGroup=L.featureGroup().addTo(mymap);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(mymap);mymap.on("contextmenu",function(c){window.location.hash="#closest-5-"+c.latlng.lat+","+c.latlng.lng})}function centreMap(){if(position){mymap.fitBounds([[position.coords.latitude-.01,position.coords.longitude-.01],[position.coords.latitude+.01,position.coords.longitude+.01]])}else{mymap.fitBounds([[49.095026,-7.742293],[60.258081000000004,1.847338]])}}function addMarker(d,e,f,g,h,i){var j=L.ExtraMarkers.icon({markerColor:h,icon:"fa-number",number:d});var k=L.marker([e,f],{icon:j});var l;if(typeof i!=="undefined"){var m=i.attr("n");var n=i.attr("r");if(n!=""){var o=$geo.find("r[id="+n+"]").closest("r[u!='']").attr("u")}l='<strong><a target="_blank" href="'+o+"/"+m+'/">'+g+'</a></strong><br /><a target="_blank" href="'+o+"/"+m+'/course/">Course page</a><br /><a target="_blank" href="https://www.google.com/maps/dir/?api=1&destination='+e+","+f+'">Directions</a>'}else if(typeof g!=="undefined"){l=g}if(options.vegan){if(typeof l!=="undefined"){l+="<br />"}l+='<a target="_blank" href="https://www.happycow.net/searchmap?lat='+e+"&lng="+f+'&vegan=true">Local vegan food</a>'}l+='<br /><a href class="complete-event" data-name="'+g+'">(completed this event)</a>';k.bindPopup(l);k.addTo(markerGroup)}function displayEvents(p){if(isNaN(p)){var q=p.indexOf("-");var r=p.substring(q+1).split(",");closestLatitude=r[0];closestLongitude=r[1];delete r;p=p.substring(0,q)}else{if(position===undefined){p=0;closestLatitude=0;closestLongitude=0}else{p=parseInt(p);closestLatitude=position.coords.latitude;closestLongitude=position.coords.longitude}}var s=[];var t=[];var u=[];$geo.find('e[lo!=""][la!=""]').each(function(){var x=$(this);var y=parseFloat(x.attr("lo"));var z=parseFloat(x.attr("la"));var A=getDistanceFromLatLonInKm(z,y,closestLatitude,closestLongitude);t.push({id:x.attr("id"),distance:A})});u=t.sort(function(B,C){return B.distance-C.distance});delete t;for(var v=0;v<u.length;v++){s.push(u[v].id)}delete u;var w=0;s.forEach(function(D){if(w<p){$event=$geo.find("e[id='"+D+"']");var E=$event.attr("m");completedEventNames=options.completedEventNames||[];if(completedEventNames.indexOf(E)==-1){addMarker(++w,$event.attr("la"),$event.attr("lo"),E,iconColours[w%iconColours.length-1],$event)}}});mymap.on("popupopen",function(){$(".complete-event").on("click",function(F){F.preventDefault();$source=$(this);options.completedEventNames=options.completedEventNames||[];options.completedEventNames.push($source.attr("data-name"));var G=window.location.pathname.split("/");var H=G.splice(0,G.length-2).join("/")+"/";Cookies.set("options",JSON.stringify(options),{expires:3650,path:H,secure:true});window.location.reload()})});mymap.fitBounds(markerGroup.getBounds())}function getDistanceFromLatLonInKm(I,J,K,M){var N=6371;var O=deg2rad(K-I);var P=deg2rad(M-J);var Q=Math.sin(O/2)*Math.sin(O/2)+Math.cos(deg2rad(I))*Math.cos(deg2rad(K))*Math.sin(P/2)*Math.sin(P/2);var R=2*Math.atan2(Math.sqrt(Q),Math.sqrt(1-Q));var S=N*R;return S}function deg2rad(T){return T*(Math.PI/180)}function load(){$(document).ready(function(){markerGroup.clearLayers();var U=decodeURIComponent(window.location.hash);var V=parseInt(U.substr(1));displayEvents(V)})}function init(){$(window).bind("hashchange",function(W){load()});$.ajax({url:"../geo.xml",async:false}).done(function(X){$geo=$(X)})}function initAndLoad(){init();load()}
