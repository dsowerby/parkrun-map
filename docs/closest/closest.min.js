var mymap;var $geo;var position;var options={};var iconColours=["red","orange-dark","orange","yellow","blue-dark","cyan","purple","violet","pink","green-dark","green","green-light","black","white"];navigator.geolocation.getCurrentPosition(function(a){position=a;initAndLoad()},function(b){initAndLoad()});$(document).ready(function(){initMap();initOptions();centreMap();initAndLoad()});function initOptions(){options=JSON.parse(Cookies.get("options")||"{}")}function initMap(){mymap=L.map("mapid",{zoomControl:false,maxBounds:new L.LatLngBounds(new L.LatLng(-90,-180),new L.LatLng(90,180)),minZoom:2});L.control.zoom({position:"topright"}).addTo(mymap);markerGroup=L.featureGroup().addTo(mymap);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(mymap);mymap.on("contextmenu",function(c){window.location.hash="#closest-5-"+c.latlng.lat+","+c.latlng.lng})}function centreMap(){if(position){mymap.fitBounds([[position.coords.latitude-.01,position.coords.longitude-.01],[position.coords.latitude+.01,position.coords.longitude+.01]])}else{mymap.fitBounds([[49.095026,-7.742293],[60.258081000000004,1.847338]])}}function addMarker(d,e,f,g,h,i){var j=L.ExtraMarkers.icon({markerColor:h,icon:"fa-number",number:d});var k=L.marker([e,f],{icon:j});var l;if(typeof i!=="undefined"){var m=i.attr("n");var n=i.attr("r");if(n!=""){var o=$geo.find("r[id="+n+"]").closest("r[u!='']").attr("u")}l='<strong><a target="_blank" href="'+o+"/"+m+'/">'+g+'</a></strong><br /><a target="_blank" href="'+o+"/"+m+'/course/">Course page</a><br /><a target="_blank" href="https://www.google.com/maps/dir/?api=1&destination='+e+","+f+'">Directions</a>'}else if(typeof g!=="undefined"){l=g}if(options.vegan){if(typeof l!=="undefined"){l+="<br />"}l+='<a target="_blank" href="https://www.happycow.net/searchmap?lat='+e+"&lng="+f+'&vegan=true">Local vegan food</a>'}l+='<br /><a href class="complete-event" data-name="'+g+'">(completed this event)</a>';k.bindPopup(l);k.addTo(markerGroup)}function displayEvents(p){if(isNaN(p)){var q=p.indexOf("-");var r=p.substring(q+1).split(",");closestLatitude=r[0];closestLongitude=r[1];delete r;p=p.substring(0,q)}else{if(position===undefined){p=0;closestLatitude=0;closestLongitude=0}else{p=parseInt(p);closestLatitude=position.coords.latitude;closestLongitude=position.coords.longitude}}var s=[];var t=[];var u=[];$geo.find('e[lo!=""][la!=""]').each(function(){var z=$(this);var A=parseFloat(z.attr("lo"));var B=parseFloat(z.attr("la"));var C=getDistanceFromLatLonInKm(B,A,closestLatitude,closestLongitude);t.push({id:z.attr("id"),distance:C})});u=t.sort(function(D,E){return D.distance-E.distance});delete t;for(var v=0;v<u.length;v++){s.push(u[v].id)}delete u;var w=0;s.forEach(function(F){if(w<p){$event=$geo.find("e[id='"+F+"']");var G=$event.attr("m");completedEventNames=options.completedEventNames||[];if(completedEventNames.indexOf(G)==-1){addMarker(++w,$event.attr("la"),$event.attr("lo"),G,iconColours[w%iconColours.length-1],$event)}}});mymap.on("popupopen",function(){$(".complete-event").on("click",function(H){H.preventDefault();$source=$(this);options.completedEventNames=options.completedEventNames||[];options.completedEventNames.push($source.attr("data-name"));var I=window.location.pathname.split("/");var J=I.splice(0,I.length-2).join("/")+"/";Cookies.set("options",JSON.stringify(options),{expires:3650,path:J,secure:true});window.location.reload()})});var x=L.icon({iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png",shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});var y=L.marker([closestLatitude,closestLongitude],{icon:x});y.addTo(markerGroup);mymap.fitBounds(markerGroup.getBounds())}function getDistanceFromLatLonInKm(K,M,N,O){var P=6371;var Q=deg2rad(N-K);var R=deg2rad(O-M);var S=Math.sin(Q/2)*Math.sin(Q/2)+Math.cos(deg2rad(K))*Math.cos(deg2rad(N))*Math.sin(R/2)*Math.sin(R/2);var T=2*Math.atan2(Math.sqrt(S),Math.sqrt(1-S));var U=P*T;return U}function deg2rad(V){return V*(Math.PI/180)}function load(){$(document).ready(function(){markerGroup.clearLayers();var W=decodeURIComponent(window.location.hash);var X=W.substring(1);displayEvents(X)})}function init(){$(window).bind("hashchange",function(Y){load()});$.ajax({url:"../geo.xml",async:false}).done(function(Z){$geo=$(Z)})}function initAndLoad(){init();load()}
