var mymap;var $geo;var position;var options={};var iconColours=["red","orange-dark","orange","yellow","blue-dark","cyan","purple","violet","pink","green-dark","green","green-light","black","white"];Array.prototype.getUnique=function(){var a={},b=[];for(var c=0;c<this.length;c++)a[this[c]]=1;for(var d in a)b.push(d);return b};navigator.geolocation.getCurrentPosition(function(e){position=e;initAndLoad()},function(f){initAndLoad()});$(document).ready(function(){initMap();initOptions();centreMap();initAndLoad()});function initOptions(){options=JSON.parse(Cookies.get("options")||"{}")}function initMap(){mymap=L.map("mapid",{zoomControl:false,maxBounds:new L.LatLngBounds(new L.LatLng(-90,-180),new L.LatLng(90,180)),minZoom:2});L.control.zoom({position:"topright"}).addTo(mymap);markerGroup=L.featureGroup().addTo(mymap);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(mymap);mymap.on("contextmenu",function(g){window.location.hash="#closest-5-"+g.latlng.lat+","+g.latlng.lng})}function centreMap(){if(position){mymap.fitBounds([[position.coords.latitude-.01,position.coords.longitude-.01],[position.coords.latitude+.01,position.coords.longitude+.01]])}else{mymap.fitBounds([[49.095026,-7.742293],[60.258081000000004,1.847338]])}}function addMarker(h,i,j,k,l,m){var n=L.ExtraMarkers.icon({markerColor:l,icon:"fa-number",number:h});var o=L.marker([i,j],{icon:n});var p;if(typeof m!=="undefined"){var q=m.attr("n");var r=m.attr("r");if(r!=""){var s=$geo.find("r[id="+r+"]").closest("r[u!='']").attr("u")}p='<strong><a target="_blank" href="'+s+"/"+q+'/">'+k+'</a></strong><br /><a target="_blank" href="'+s+"/"+q+'/course/">Course page</a><br /><a target="_blank" href="https://www.google.com/maps/dir/?api=1&destination='+i+","+j+'">Directions</a>'}else if(typeof k!=="undefined"){p=k}if(options.vegan){if(typeof p!=="undefined"){p+="<br />"}p+='<a target="_blank" href="https://www.happycow.net/searchmap?lat='+i+"&lng="+j+'&vegan=true">Local vegan food</a>'}p+='<br /><a href class="complete-event" data-name="'+k+'">(completed this event)</a>';o.bindPopup(p);o.addTo(markerGroup)}function displayEvents(t){if(isNaN(t)){var u=t.indexOf("-");var v=t.substring(u+1).split(",");closestLatitude=v[0];closestLongitude=v[1];delete v;t=t.substring(0,u)}else{if(position===undefined){t=0;closestLatitude=0;closestLongitude=0}else{t=parseInt(t);closestLatitude=position.coords.latitude;closestLongitude=position.coords.longitude}}var w=[];var x=[];var y=[];$geo.find('e[lo!=""][la!=""]').each(function(){var D=$(this);var E=parseFloat(D.attr("lo"));var F=parseFloat(D.attr("la"));var G=getDistanceFromLatLonInKm(F,E,closestLatitude,closestLongitude);x.push({id:D.attr("id"),distance:G})});y=x.sort(function(H,I){return H.distance-I.distance});delete x;for(var z=0;z<y.length;z++){w.push(y[z].id)}delete y;var A=0;w.forEach(function(J){if(A<t){$event=$geo.find("e[id='"+J+"']");var K=$event.attr("m");completedEventNames=options.completedEventNames||[];completedEventNames=completedEventNames.getUnique();if(completedEventNames.indexOf(K)==-1){addMarker(++A,$event.attr("la"),$event.attr("lo"),K,iconColours[A%iconColours.length-1],$event)}}});mymap.on("popupopen",function(){$(".complete-event").on("click",function(M){M.preventDefault();$source=$(this);options.completedEventNames=options.completedEventNames||[];options.completedEventNames.push($source.attr("data-name"));var N=window.location.pathname.split("/");var O=N.splice(0,N.length-2).join("/")+"/";Cookies.set("options",JSON.stringify(options),{expires:3650,path:O,secure:true});window.location.reload()})});var B=L.icon({iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png",shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});var C=L.marker([closestLatitude,closestLongitude],{icon:B});C.addTo(markerGroup);mymap.fitBounds(markerGroup.getBounds())}function getDistanceFromLatLonInKm(P,Q,R,S){var T=6371;var U=deg2rad(R-P);var V=deg2rad(S-Q);var W=Math.sin(U/2)*Math.sin(U/2)+Math.cos(deg2rad(P))*Math.cos(deg2rad(R))*Math.sin(V/2)*Math.sin(V/2);var X=2*Math.atan2(Math.sqrt(W),Math.sqrt(1-W));var Y=T*X;return Y}function deg2rad(Z){return Z*(Math.PI/180)}function load(){$(document).ready(function(){markerGroup.clearLayers();var _=decodeURIComponent(window.location.hash);var aa=_.substring(1);displayEvents(aa)})}function init(){$(window).bind("hashchange",function(ba){load()});$.ajax({url:"../geo.xml",async:false}).done(function(ca){$geo=$(ca)})}function initAndLoad(){init();load()}
