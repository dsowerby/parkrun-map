var mymap;var $geo;var position;var options={};var athleteData=[];var iconColours=["red","orange-dark","orange","yellow","blue-dark","cyan","purple","violet","pink","green-dark","green","green-light","black","white"];Array.prototype.getUnique=function(){var a={},b=[];for(var c=0;c<this.length;c++)a[this[c]]=1;for(var d in a)b.push(d);return b};navigator.geolocation.getCurrentPosition(function(e){position=e;initAndLoad()},function(f){initAndLoad()});$(document).ready(function(){initMap();initOptions();centreMap();initAndLoad()});function initOptions(){options=JSON.parse(Cookies.get("options")||"{}")}function initMap(){mymap=L.map("mapid",{fullscreenControl:true,zoomControl:false,maxBounds:new L.LatLngBounds(new L.LatLng(-90,-180),new L.LatLng(90,180)),minZoom:2});L.control.zoom({position:"topright"}).addTo(mymap);markerGroup=L.featureGroup().addTo(mymap);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(mymap);mymap.on("contextmenu",function(g){window.location.hash="#5-"+g.latlng.lat+","+g.latlng.lng})}function centreMap(){if(position){mymap.fitBounds([[position.coords.latitude-.01,position.coords.longitude-.01],[position.coords.latitude+.01,position.coords.longitude+.01]])}else{mymap.fitBounds([[49.095026,-7.742293],[60.258081000000004,1.847338]])}}function addDoneMarker(h,i,j,k){var l=L.ExtraMarkers.icon({markerColor:"green-light",icon:"check",prefix:"fa"});addMarker(l,h,i,j,k)}function addIndexMarker(m,n,o,p,q,r){var s=L.ExtraMarkers.icon({markerColor:q,icon:"fa-number",number:m});addMarker(s,n,o,p,r)}function addMarker(t,u,v,w,x){var y=L.marker([u,v],{icon:t});var z;if(typeof x!=="undefined"){var A=x.attr("n");var B=x.attr("r");if(B!=""){var C=$geo.find("r[id="+B+"]").closest("r[u!='']").attr("u")}z='<strong><a target="_blank" href="'+C+"/"+A+'/">'+w+'</a></strong><br /><a target="_blank" href="'+C+"/"+A+'/course/">Course page</a><br /><a target="_blank" href="https://www.google.com/maps/dir/?api=1&destination='+u+","+v+'">Directions</a>'}else if(typeof w!=="undefined"){z=w}if(options.vegan){if(typeof z!=="undefined"){z+="<br />"}z+='<a target="_blank" href="https://www.happycow.net/searchmap?lat='+u+"&lng="+v+'&vegan=true">Local vegan food</a>'}y.bindPopup(z);y.addTo(markerGroup)}function displayEvents(D){if(isNaN(D)){var E=D.indexOf("-");var F=D.substring(E+1).split(",");closestLatitude=F[0];closestLongitude=F[1];delete F;D=D.substring(0,E)}else{if(position===undefined){D=0;closestLatitude=0;closestLongitude=0}else{D=parseInt(D);closestLatitude=position.coords.latitude;closestLongitude=position.coords.longitude}}var G=[];var H=[];var I=[];$geo.find('e[lo!=""][la!=""]').each(function(){var O=$(this);var P=parseFloat(O.attr("lo"));var Q=parseFloat(O.attr("la"));var R=getDistanceFromLatLonInKm(Q,P,closestLatitude,closestLongitude);H.push({id:O.attr("id"),distance:R})});I=H.sort(function(S,T){return S.distance-T.distance});delete H;for(var J=0;J<I.length;J++){G.push(I[J].id)}delete I;if(typeof(options.athleteId==="string")){if(typeof athleteData[options.athleteId]==="undefined"){$.ajax({url:"https://cors-anywhere.herokuapp.com/https://www.parkrun.org.uk:443/results/athleteeventresultshistory/?athleteNumber="+options.athleteId+"&eventNumber=0",async:false}).done(function(U){athleteData[options.athleteId]=$(U)})}}var K=0;G.forEach(function(V){if(K<D){$event=$geo.find("e[id='"+V+"']");var W=$event.attr("m");var X=false;if(typeof options.athleteId==="undefined"||typeof athleteData==="undefined"||typeof athleteData[options.athleteId]=="undefined"){X=true}else if(athleteData[options.athleteId].find("a[href$='/"+$event.attr("n")+"/results']").length==0){X=true}else{addDoneMarker($event.attr("la"),$event.attr("lo"),W,$event)}if(X){addIndexMarker(++K,$event.attr("la"),$event.attr("lo"),W,iconColours[K%iconColours.length-1],$event)}}});var M=L.icon({iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png",shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});var N=L.marker([closestLatitude,closestLongitude],{icon:M});N.addTo(markerGroup);mymap.fitBounds(markerGroup.getBounds())}function getDistanceFromLatLonInKm(Y,Z,_,aa){var ba=6371;var ca=deg2rad(_-Y);var da=deg2rad(aa-Z);var ea=Math.sin(ca/2)*Math.sin(ca/2)+Math.cos(deg2rad(Y))*Math.cos(deg2rad(_))*Math.sin(da/2)*Math.sin(da/2);var fa=2*Math.atan2(Math.sqrt(ea),Math.sqrt(1-ea));var ga=ba*fa;return ga}function deg2rad(ha){return ha*(Math.PI/180)}function load(){$(document).ready(function(){markerGroup.clearLayers();var ia=decodeURIComponent(window.location.hash);var ja=ia.substring(1);displayEvents(ja)})}function init(){$(window).bind("hashchange",function(ka){load()});$.ajax({url:"../geo.xml",async:false}).done(function(la){$geo=$(la)})}function initAndLoad(){init();load()}
