var mymap;var $geo;var position;var options={};var iconColours=["red","orange-dark","orange","yellow","blue-dark","cyan","purple","violet","pink","green-dark","green","green-light","black","white"];navigator.geolocation.getCurrentPosition(function(a){position=a;initAndLoad()},function(b){initAndLoad()});$(document).ready(function(){initMap();initOptions();centreMap();initAndLoad()});function initOptions(){options=JSON.parse(Cookies.get("options")||"{}")}function initMap(){mymap=L.map("mapid",{zoomControl:false,maxBounds:new L.LatLngBounds(new L.LatLng(-90,-180),new L.LatLng(90,180)),minZoom:2});L.control.zoom({position:"topright"}).addTo(mymap);markerGroup=L.featureGroup().addTo(mymap);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(mymap);mymap.on("contextmenu",function(c){window.location.hash="#closest-5-"+c.latlng.lat+","+c.latlng.lng})}function centreMap(){if(position){mymap.fitBounds([[position.coords.latitude-.01,position.coords.longitude-.01],[position.coords.latitude+.01,position.coords.longitude+.01]])}else{mymap.fitBounds([[49.095026,-7.742293],[60.258081000000004,1.847338]])}}function addMarker(d,e,f,g,h,i){var j=L.ExtraMarkers.icon({markerColor:h,icon:"fa-number",number:d});var k=L.marker([e,f],{icon:j});var l;if(typeof i!=="undefined"){var m=i.attr("n");var n=i.attr("r");if(n!=""){var o=$geo.find("r[id="+n+"]").closest("r[u!='']").attr("u")}l='<strong><a target="_blank" href="'+o+"/"+m+'/">'+g+'</a></strong><br /><a target="_blank" href="'+o+"/"+m+'/course/">Course page</a><br /><a target="_blank" href="https://www.google.com/maps/dir/?api=1&destination='+e+","+f+'">Directions</a>'}else if(typeof g!=="undefined"){l=g}if(options.vegan){if(typeof l!=="undefined"){l+="<br />"}l+='<a target="_blank" href="https://www.happycow.net/searchmap?lat='+e+"&lng="+f+'&vegan=true">Local vegan food</a>'}l+='<br /><a href class="complete-event" data-name="'+g+'">(completed this event)</a>';k.bindPopup(l);k.addTo(markerGroup)}function displayEvents(q){if(isNaN(q)){var r=q.indexOf("-");var s=q.substring(r+1).split(",");closestLatitude=s[0];closestLongitude=s[1];delete s;q=q.substring(0,r)}else{if(position===undefined){q=0;closestLatitude=0;closestLongitude=0}else{q=parseInt(q);closestLatitude=position.coords.latitude;closestLongitude=position.coords.longitude}}var t=[];var u=[];var v=[];$geo.find('e[lo!=""][la!=""]').each(function(){var y=$(this);var z=parseFloat(y.attr("lo"));var A=parseFloat(y.attr("la"));var B=getDistanceFromLatLonInKm(A,z,closestLatitude,closestLongitude);u.push({id:y.attr("id"),distance:B})});v=u.sort(function(C,D){return C.distance-D.distance});delete u;for(var w=0;w<v.length;w++){t.push(v[w].id)}delete v;var x=0;t.forEach(function(E){if(x<q){$event=$geo.find("e[id='"+E+"']");var F=$event.attr("m");completedEventNames=options.completedEventNames||[];if(completedEventNames.indexOf(F)==-1){addMarker(++x,$event.attr("la"),$event.attr("lo"),F,iconColours[x%iconColours.length-1],$event)}}});mymap.on("popupopen",function(){$(".complete-event").on("click",function(G){G.preventDefault();$source=$(this);options.completedEventNames=options.completedEventNames||[];options.completedEventNames.push($source.attr("data-name"));var H=window.location.pathname.split("/");var I=H.splice(0,H.length-2).join("/")+"/";Cookies.set("options",JSON.stringify(options),{expires:3650,path:I,secure:true});window.location.reload()})});mymap.fitBounds(markerGroup.getBounds())}function getDistanceFromLatLonInKm(J,K,M,N){var O=6371;var P=deg2rad(M-J);var Q=deg2rad(N-K);var R=Math.sin(P/2)*Math.sin(P/2)+Math.cos(deg2rad(J))*Math.cos(deg2rad(M))*Math.sin(Q/2)*Math.sin(Q/2);var S=2*Math.atan2(Math.sqrt(R),Math.sqrt(1-R));var T=O*S;return T}function deg2rad(U){return U*(Math.PI/180)}function load(){$(document).ready(function(){markerGroup.clearLayers();var V=decodeURIComponent(window.location.hash);var W=p.substring(1);displayEvents(W)})}function init(){$(window).bind("hashchange",function(X){load()});$.ajax({url:"../geo.xml",async:false}).done(function(Y){$geo=$(Y)})}function initAndLoad(){init();load()}
